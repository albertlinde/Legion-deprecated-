function ConnectionManager(e){this.legion=e,this.serverConnection=null,this.peerConnections=new ALMap;var t=this;this.legion.messagingAPI.setHandlerFor("OfferAsAnswer",function(e,n){t.handleSignalling(e,n)}),this.legion.messagingAPI.setHandlerFor("OfferReturn",function(e,n){t.handleSignalling(e,n)}),this.legion.messagingAPI.setHandlerFor("ICE",function(e,n){t.handleSignalling(e,n)})}function ALList(){this.list=[]}function Legion(e){this.options=e,this.onJoinCallback=null,e.clientID||(e.clientID=this.randInt()),e.overlayProtocol||(e.overlayProtocol=B2BOverlay),e.messagingProtocol||(e.messagingProtocol=FloodMessaging),e.objectOptions||(e.objectOptions={serverInterval:5e3,peerInterval:200}),e.bullyProtocol||(e.bullyProtocol={type:ServerBully}),e.signallingConnection||(e.signallingConnection={type:ServerConnection,server:{ip:"localhost",port:8002}}),e.objectServerConnection||(e.objectServerConnection={type:ObjectServerConnection,server:{ip:"localhost",port:8004}}),e.securityProtocol||(e.securityProtocol=SecurityProtocol),this.messageCount=this.randInt(),this.id=this.options.clientID,this.messagingAPI=new MessagingAPI(this),this.options.bullyProtocol&&(this.bullyProtocol=new this.options.bullyProtocol.type(this)),this.overlay=new Overlay(this,this),this.connectionManager=new ConnectionManager(this),this.objectStore=null}function ALMap(){this.map={}}function MessagingAPI(e){this.legion=e,this.messagingProtocol=new this.legion.options.messagingProtocol(this,this.legion),this.callbacks=new ALMap,this.duplicates=new Duplicates}function ALQueue(){this.queue=[]}function ObjectServerConnection(e,t,n){this.server=e,this.objectStore=t,this.legion=n,this.remoteID=this.server.ip+":"+this.server.port,this.socket=new WebSocket("ws://"+this.server.ip+":"+this.server.port);var o=this;this.socket.onopen=function(){o.legion.generateMessage("CLIENT_ID",null,function(e){e.clientID=o.legion.id,o.send(JSON.stringify(e))}),o.legion.connectionManager.onOpenServer(o)},this.socket.onmessage=function(e){var t=JSON.parse(e.data);console.log("Got "+t.type+" from "+o.remoteID+" s: "+t.sender);var n=JSON.parse(e.data);t.content?decompress(t.content,function(e){t.content=JSON.parse(e),o.objectStore.onMessageFromServer(t,n,o)}):o.objectStore.onMessageFromServer(t,n,o)},this.socket.onclose=function(){o.legion.connectionManager.onCloseServer(o)},this.socket.onerror=function(e){console.error("ServerSocket Error",e)}}function ALSet(){this.set={}}function ObjectStore(e){this.legion=e,this.types=new ALMap,this.crdts=new ALMap,this.objectServer=null,this.peerSyncs=new ALMap;var t=this;this.handlers={peerSync:{type:"OS:PS",callback:function(e){var n=t.peerSyncs.get(e.sender);n?n.handleSync(e):console.warn("Got OS:PS for unknown peer.")}},peerSyncAnswer:{type:"OS:PSA",callback:function(e){var n=t.peerSyncs.get(e.sender);n?n.handleSyncAnswer(e):console.warn("Got OS:PSA for unknown peer.")}},gotContentFromNetwork:{type:"OS:C",callback:function(e,n,o){t.gotContentFromNetwork(e,n,o)}},version_vector_propagation:{type:"OS:VVP",callback:function(e,n,o){t.gotVVFromNetwork(e,n,o)}}},this.serverQueue=new ALQueue,this.serverTimer=setInterval(function(){t.clearServerQueue()},this.legion.options.objectOptions.serverInterval),this.peersQueue=new ALQueue,this.peersTimer=setInterval(function(){t.clearPeersQueue()},this.legion.options.objectOptions.peerInterval);var n=this.legion.overlay.getPeers();n.length>0&&console.warn("Already have peers!",n.length);for(var o=0;o<n.length;o++){var s=new PeerSync(this.legion,this,n[o]);this.peerSyncs.set(n[o].remoteID,s),s.sync()}this.legion.messagingAPI.setHandlerFor(this.handlers.peerSync.type,this.handlers.peerSync.callback),this.legion.messagingAPI.setHandlerFor(this.handlers.peerSyncAnswer.type,this.handlers.peerSyncAnswer.callback),this.legion.messagingAPI.setHandlerFor(this.handlers.gotContentFromNetwork.type,this.handlers.gotContentFromNetwork.callback),this.legion.messagingAPI.setHandlerFor(this.handlers.version_vector_propagation.type,this.handlers.version_vector_propagation.callback),this.legion.bullyProtocol.setOnBullyCallback(function(e){t.checkIfMustHaveServer()}),this.defineCRDT(CRDT_LIB.STATE_Counter),this.defineCRDT(CRDT_LIB.OPERATIONS_Counter),this.defineCRDT(CRDT_LIB.OPERATIONS_Set),this.defineCRDT(CRDT_LIB.STATE_Set),this.defineCRDT(CRDT_LIB.OPERATIONS_Map),this.defineCRDT(CRDT_LIB.STATE_Map),this.defineCRDT(CRDT_LIB.OPERATIONS_List)}function compress(e,t){"undefined"!=typeof LZMA?LZMA.compress(e,1,function(e){for(var n="",o=0;o<e.length;o++)n+=fromDecToHex(e[o]);t(n)},function(){}):t(e)}function decompress(e,t){for(var n=[],o=0;o<e.length;o+=2)n.push(fromHexToDec(e[o]+e[o+1]));"undefined"!=typeof LZMA?LZMA.decompress(n,function(e){t(e)},function(){}):t(e)}function Overlay(e){this.legion=e,this.peers=new ALMap,this.overlayProtocol=new this.legion.options.overlayProtocol(this,this.legion),this.onChangeCallback=null}function Duplicates(){this.senders=[]}function RangeSet(){this.pairs=[]}function PeerConnection(e,t){detailedDebug&&console.log("PC from "+t.id+" to "+e),this.remoteID=e,this.legion=t,this.peer=new RTCPeerConnection(servers,pcConstraint),this.channel=null;var n=this;this.init_timeout=setTimeout(function(){n.onInitTimeout()},DEFAULT_PEER_INIT_TIMEOUT),this.unique=null,this.lastKeepAlive=Date.now(),this.keepAliveInterval=setInterval(function(){n.keepAlive()},KEEP_ALIVE_INTERVAL)}function CRDT(e,t,n){this.objectStore=n,this.objectID=e,this.crdt=t,this.state={},this.getValue=t.crdt.getValue,this.merge=t.crdt.merge,this.compare=t.crdt.compare,this.fromJSONString=t.crdt.fromJSONString,this.toJSONString=t.crdt.toJSONString,this.garbageCollect=t.crdt.garbageCollect,this.getDelta=t.crdt.getDelta,this.applyDelta=t.crdt.applyDelta,this.gcvv={};for(var o=Object.keys(this.crdt.crdt.base_value.state),s=0;s<o.length;s++)"function"==typeof this.crdt.crdt.base_value.state[o[s]]?this.state[o[s]]=new this.crdt.crdt.base_value.state[o[s]]:this.state[o[s]]=JSON.parse(JSON.stringify(this.crdt.crdt.base_value.state[o[s]]));this.locals=[],this.remotes=[],this.localOP=0,this.opHistory=new ALMap,this.versionVector=new ALMap;var i=Object.keys(this.crdt.crdt.operations),r=this;if(this.crdt.propagation==CRDT.OP_BASED)for(var s=0;s<i.length;s++)!function(e){r.locals[e]=r.crdt.crdt.operations[e].local,r.remotes[e]=r.crdt.crdt.operations[e].remote,r[e]=function(){var t=r.locals[e].apply(r,arguments),n=r.getVersionVector();if(!t)return r.remotes[e].apply(r,arguments);if("undefined"==typeof CRDT_Database){var o=r.remotes[e].apply(r,[t]);return r.addOpToHistory(r.objectStore.legion.id,++r.localOP,t,e,n),r.addOpToCurrentVersionVector(r.objectStore.legion.id,r.localOP),r.objectStore.propagate(r.objectID,r.objectStore.legion.id,r.localOP,{all:!0},r.crdt.type),r.callback&&r.callback(o,{local:!0}),o}var o=r.remotes[e].apply(r,[t]);r.addOpToHistory("ObjectServer",++r.localOP,t,e,n),r.addOpToCurrentVersionVector("ObjectServer",r.localOP),r.objectStore.propagate(r.objectID,"ObjectServer",r.localOP,{all:!0},r.crdt.type),r.callback&&r.callback(o,{local:!0})}}(i[s]);else if(this.crdt.propagation==CRDT.STATE_BASED)for(var s=0;s<i.length;s++)!function(e){r[e]=function(){var t=r.crdt.crdt.operations[e].apply(r,arguments);return t.change?(r.objectStore.propagateState(r.objectID,{all:!0}),void(r.callback&&r.callback(t,{local:!0}))):t}}(i[s]);else if(this.crdt.propagation==CRDT.DELTA_BASED)for(var s=0;s<i.length;s++)!function(e){r[e]=function(){for(var t={id:r.objectStore.legion.id,o:++r.localOP},n=[],o=0;o<arguments.length;o++)n.push(arguments[o]);n.push(t);var s=r.crdt.crdt.operations[e].apply(r,n);r.addOpToCurrentVersionVector(t.id,t.o),r.objectStore.propagateDelta(r.objectID,{all:!0}),r.callback&&r.callback(s,{local:!0})}}(i[s]);else console.error("No def for propagation type",this.crdt.propagation),console.error(JSON.stringify(this.crdt),e);this.callback=null}function ServerConnection(e,t){this.legion=t,this.server=e,this.remoteID=this.server.ip+":"+this.server.port,this.socket=new WebSocket("ws://"+this.server.ip+":"+this.server.port);var n=this;this.socket.onopen=function(){n.socket.send(t.secure.getServerAuthenticationChallenge())},this.socket.onmessage=function(e){var o=JSON.parse(e.data);if(console.log("Got "+o.type+" from "+n.remoteID+" s: "+o.sender),o.auth)t.secure.gotServerAuthenticationResult(o.auth),"Success"==o.auth.result&&n.legion.connectionManager.onOpenServer(n);else{var s=JSON.parse(e.data);o.content?decompress(o.content,function(e){o.content=JSON.parse(e),n.legion.messagingAPI.onMessage(n,o,s)}):decompress("5d00000100040000000000000000331849b7e4c02e1ffffac8a000",function(e){n.legion.messagingAPI.onMessage(n,o,s)})}},this.socket.onclose=function(){n.legion.connectionManager.onCloseServer(n)},this.socket.onerror=function(e){console.error("ServerSocket Error",e)}}function PeerSync(e,t,n){console.log("New peerSync from "+e.id+" to "+n.remoteID),this.legion=e,this.objectStore=t,this.peerConnection=n,this.isSynced=!1,this.queueAfterSync=new ALQueue,this.sharedObjects=new ALMap;var o=this;this.psTimeout=setTimeout(function(){console.error("No PeerSync in time.",o.legion.id,o.peerConnection.remoteID)},5e3)}function CliquesOverlay(e,t){this.overlay=e,this.legion=t;var n=this;this.interval=setInterval(function(){n.floodJoin()},15e3),this.started=!1,setTimeout(function(){n.floodJoin()},3e3),this.legion.messagingAPI.setHandlerFor("Connect",function(e,t,o){n.handleJoin(e,t,o)})}function DS_DLList(){this.head=null,this.tail=null,this.count=0}function DS_DLL_Node(e){this.next=null,this.previous=null,this.element=e}function SecurityProtocol(e){this.legion=e,this.keys=new ALMap,this.currKey=null,this.serverPublicKey=null,this.queue=new DS_DLList}function DS_TableList(){this.list=[]}function B2BOverlay(e,t){this.overlay=e,this.legion=t,this.meta_interval=55e3,this.initial_ttl=3,this.initial_n=7,this.min=5,this.max=8,this.conn_check_timeout=8e3,this.conn_check_timeout_startup=2e4,this.conn_check_timeout_multiplier=1.5,this.RAND_VAL=.3;var n=this;this.legion.messagingAPI.setHandlerFor("P2PMeta",function(e,t,o){n.gotP2PMeta(e,t,o)}),this.legion.messagingAPI.setHandlerFor("JoinRequest",function(e,t,o){n.onJoinRequest(e,t,o)}),this.legion.messagingAPI.setHandlerFor("JoinAnswer",function(e,t,o){n.onJoinAnswer(e,t,o)});var o=function(){n.sendP2PMeta(),n.meta_interval=Math.min(n.meta_interval+2500,35e3),setTimeout(o,n.meta_interval)};setTimeout(o,n.meta_interval);var s=function(){n.checkIfMustHaveServer();var e=!1;n.overlay.peerCount()<n.min&&(n.legion.generateMessage("JoinRequest",null,function(e){e.N=n.max-n.overlay.peerCount(),e.TTL=n.initial_ttl,n.legion.messagingAPI.propagateToN(e,!0)}),e=!0),n.overlay.peerCount()>n.max&&n.removeBestPeer(),e?setTimeout(s,n.conn_check_timeout):setTimeout(s,Math.min(30,n.conn_check_timeout*n.conn_check_timeout_multiplier))};this.legion.bullyProtocol.setOnBullyCallback(function(e){n.checkIfMustHaveServer()}),setTimeout(s,n.conn_check_timeout_startup)}function ServerBully(e){this.legion=e,this.lastSHB=null;var t=this;this.handlers={bully:{type:"SHB",callback:function(e,n,o){if(o instanceof ServerConnection)t.lastSHB=e,e.ID>t.legion.secure.getCurrentKeyID()&&o.socket.send(t.legion.secure.getServerAuthenticationChallenge()),t.floodBully();else if(t.legion.secure.verifySHB(e)){var s=o.remoteID;s<=t.bully?(t.bully=s,t.bullied(),"undefined"!=typeof bullyLog&&bullyLog&&console.log("Be bullied by",s)):("undefined"!=typeof bullyLog&&bullyLog&&console.log("Be bullied by",s,"but mine is",t.bully),t.onClientConnection(o))}else console.warn("Error on verifying SHB")}}},this.bully=this.legion.id.toString(),this.legion.messagingAPI.setHandlerFor(this.handlers.bully.type,this.handlers.bully.callback),this.callbacks=[]}function SimpleBully(e){this.legion=e;var t=this;this.handlers={bully:{type:"Bully",callback:function(e,n){var o=e.sender.toString(),s=Date.now();o<=t.bully?(t.bully=o,t.lastBullyMessage=s,t.bullied(),"undefined"!=typeof bullyLog&&bullyLog&&console.log("Be bullied by",o)):("undefined"!=typeof bullyLog&&bullyLog&&console.log("Be bullied by",o,"but mine is",t.bully),t.onClientConnection(n))}}},this.bully=this.legion.id.toString(),this.lastBullyMessage=Date.now(),this.bullyMustHaveInterval=this.legion.options.bullyProtocol.options.bullyMustHaveInterval,this.bullySendInterval=this.legion.options.bullyProtocol.options.bullySendInterval,this.bullyStartTime=this.legion.options.bullyProtocol.options.bullyStartTime,setTimeout(function(){t.interval=setInterval(function(){t.floodBully()},t.bullySendInterval)},t.bullyStartTime),this.legion.messagingAPI.setHandlerFor(this.handlers.bully.type,this.handlers.bully.callback),this.callbacks=[]}function FloodMessaging(e,t){this.messagingAPI=e,this.legion=t}function SimpleOverlay(e,t){this.overlay=e,this.legion=t;var n=this;this.interval=setInterval(function(){n.floodJoin()},15e3),this.started=!1,setTimeout(function(){n.floodJoin()},2e3),this.legion.messagingAPI.setHandlerFor("ConnectToAnyNodesPlease",function(e,t,o){n.handleJoin(e,t,o)})}var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,debug=!1,objectsDebug=!1,detailedDebug=!1,bullyLog=!0;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t,e.play()},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.mozSrcObject=t.mozSrcObject,e.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(debug&&console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(e,t){"undefined"!=typeof e.srcObject?e.srcObject=t:"undefined"!=typeof e.mozSrcObject?e.mozSrcObject=t:"undefined"!=typeof e.src?e.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},reattachMediaStream=function(e,t){e.src=t.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):(RTCPeerConnection=null,console.log("Browser does not appear to be WebRTC-capable")),ConnectionManager.prototype.startSignallingConnection=function(){this.serverConnection||new this.legion.options.signallingConnection.type(this.legion.options.signallingConnection.server,this.legion)},ConnectionManager.prototype.hasPeer=function(e){return this.peerConnections.contains(e)},ConnectionManager.prototype.connectPeer=function(e){return!this.hasPeer(e)&&(this.peerConnections.set(e,new PeerConnection(e,this.legion)),this.peerConnections.get(e).startLocal(),!0)},ConnectionManager.prototype.connectPeerRemote=function(e){var t=e.sender,n=e.content,o=this.peerConnections.get(t);o?t<this.legion.id&&(this.peerConnections.get(t).cancelAll(),this.peerConnections.set(t,new PeerConnection(t,this.legion)),this.peerConnections.get(t).startRemote(n,e.unique)):(this.peerConnections.set(t,new PeerConnection(t,this.legion)),this.peerConnections.get(t).startRemote(n,e.unique))},ConnectionManager.prototype.handleSignalling=function(e,t){if(e.destination!=this.legion.id)this.legion.messagingAPI.broadcastMessage(t);else if("OfferAsAnswer"==e.type)this.connectPeerRemote(e);else{var n=e.unique;if(this.peerConnections.contains(e.sender)){var o=this.peerConnections.get(e.sender);if(o.unique!=n)console.warn("Got as unique",n,"when expecting",o.unique);else switch(e.type){case"OfferReturn":return void o.returnOffer(e.content);case"ICE":return void o.return_ice(e.content)}}else console.warn("Got",e.type,"for no peer",e.sender,this.legion.id)}},ConnectionManager.prototype.onCloseServer=function(e){console.log(this.legion.getTime()+" Overlay CLOSE "+this.legion.id+" to "+e.remoteID+" of type "+e.constructor.name),this.serverConnection=null,e instanceof this.legion.options.signallingConnection.type&&(this.serverConnection=null,this.legion.overlay.onServerDisconnect(e)),e instanceof this.legion.options.objectServerConnection.type&&(this.legion.objectStore?this.legion.objectStore.onServerDisconnect(e):console.error("Should not disconnect form objects server when not having an objects store!")),this.legion.bullyProtocol&&this.legion.bullyProtocol.onServerDisconnect(e)},ConnectionManager.prototype.onOpenServer=function(e){console.log(this.legion.getTime()+" Overlay OPEN "+this.legion.id+" to "+e.remoteID+" of type "+e.constructor.name),e instanceof this.legion.options.signallingConnection.type&&(this.serverConnection=e,this.legion.overlay.onServerConnection(e)),e instanceof this.legion.options.objectServerConnection.type&&(this.legion.objectStore?this.legion.objectStore.onServerConnection(e):console.error("Should not connect to objects server when not having an objects store!")),this.legion.bullyProtocol&&this.legion.bullyProtocol.onServerConnection(e),this.legion.onOpenServer(e)},ConnectionManager.prototype.onOpenClient=function(e){console.log(this.legion.getTime()+" Overlay OPEN "+this.legion.id+" to "+e.remoteID),this.legion.overlay.addPeer(e),this.legion.objectStore&&this.legion.objectStore.onClientConnection(e),this.legion.bullyProtocol&&this.legion.bullyProtocol.onClientConnection(e)},ConnectionManager.prototype.onCloseClient=function(e){console.log(this.legion.getTime()+" Overlay CLOSE "+this.legion.id+" to "+e.remoteID),this.peerConnections["delete"](e.remoteID),this.legion.overlay.removePeer(e),this.legion.objectStore&&this.legion.objectStore.onClientDisconnect(e),this.legion.bullyProtocol&&this.legion.bullyProtocol.onClientDisconnect(e)},ConnectionManager.prototype.sendStartOffer=function(e,t,n){var o=this;this.legion.generateMessage("OfferAsAnswer",e,function(e){e.destination=n.remoteID,e.unique=t,o.legion.messagingAPI.broadcastMessage(e)})},ConnectionManager.prototype.sendReturnOffer=function(e,t,n){var o=this;this.legion.generateMessage("OfferReturn",e,function(e){e.destination=n.remoteID,e.unique=t,o.legion.messagingAPI.broadcastMessage(e)})},ConnectionManager.prototype.sendICE=function(e,t,n){var o=this;this.legion.generateMessage("ICE",e,function(e){e.destination=n.remoteID,e.unique=t,o.legion.messagingAPI.broadcastMessage(e)})},"undefined"!=typeof exports&&(exports.ALList=ALList),ALList.prototype.size=function(){return this.list.length},ALList.prototype.asArray=function(){return this.list},ALList.prototype.put=function(e,t){return e<0||e>=this.list.length?null:void(this.list=this.list.slice(0,e).concat([t]).concat(this.list.slice(e,this.size())))},ALList.prototype.remove=function(e){var t=this.list[e];if(t)return this.list=this.list.slice(0,e).concat(this.list.slice(e+1,this.size())),t},ALList.prototype.get=function(e){return e<0||e>=this.list.length?null:this.list[e]},ALList.prototype.toJSONString=function(){return this.list},ALList.prototype.fromJSONString=function(e){e?this.list=e:this.list=[]},Legion.prototype.join=function(){this.secure=new this.options.securityProtocol(this),this.connectionManager.startSignallingConnection()},Legion.prototype.getMessageAPI=function(){return this.messagingAPI},Legion.prototype.getObjectStore=function(){return this.objectStore||(this.objectStore=new ObjectStore(this)),this.objectStore},Legion.prototype.generateMessage=function(e,t,n){function o(e){var t=0;return function(n,o){return 0!==t&&"object"==typeof e&&"object"==typeof o&&e==o?"[Circular]":t>=29?"[Unknown]":(++t,o)}}if(!e)return void console.error("No type for message.");var s={type:e,sender:this.id,ID:++this.messageCount};if(t){var i;try{i=JSON.stringify(t)}catch(r){return console.error(r),console.error(t),console.log("Censoring: ",t),void console.log("Result: ",JSON.stringify(t,o(t)))}compress(i,function(e){s.content=e,n(s)},function(e){console.error("Compress failed!",e),n(null)})}else n(s)},Legion.prototype.reGenerateMessage=function(e,t,n){t?compress(JSON.stringify(t),function(t){e.content=t,n(e)},function(e){console.error("Compress failed!",e),n(null)}):(e.content&&delete e.content,n(e))},Legion.prototype.getTime=function(){return Date.now()},Legion.prototype.randInt=function(){return Math.floor(Math.random()*Number.MAX_VALUE%Math.pow(10,10))},Legion.prototype.onJoin=function(e){this.onJoinCallback=e},Legion.prototype.onOpenServer=function(e){this.onJoinCallback&&(this.onJoinCallback(),this.onJoinCallback=null)},"undefined"!=typeof exports&&(exports.ALMap=ALMap),ALMap.prototype.set=function(e,t){"object"==typeof e&&(e=JSON.stringify(e)),this.map[e]=t},ALMap.prototype.setAll=function(e,t){if(t instanceof Array)for(var n=0;n<e.length;n++)"object"==typeof e[n]?this.set(JSON.stringify(e[n]),t[n]):this.set(e[n],t[n]);else for(var n=0;n<e.length;n++)"object"==typeof e[n]?this.set(JSON.stringify(e[n]),t):this.set(e[n],t)},ALMap.prototype.deleteAll=function(e){for(var t=0;t<e.length;t++)this["delete"](e[t])},ALMap.prototype["delete"]=function(e){this.map[e]=null,delete this.map[e]},ALMap.prototype.get=function(e){return"object"==typeof e?this.map[JSON.stringify(e)]:this.map[e]},ALMap.prototype.contains=function(e){return"object"==typeof e?"undefined"!=typeof this.map[JSON.stringify(e)]:"undefined"!=typeof this.map[e]},ALMap.prototype.keys=function(){return Object.keys(this.map)},ALMap.prototype.values=function(){for(var e=[],t=this.keys(),n=0;n<t.length;n++)e.push(this.get(t[n]));return e},ALMap.prototype.size=function(){return this.keys().length},ALMap.prototype.clear=function(){return this.map=[]},MessagingAPI.prototype.onMessage=function(e,t,n){return t.sender==this.legion.id?void console.warn("Return to creator fault",t,e.remoteID):void("SHB"!=t.type&&this.duplicates.contains(t.sender,t.ID)||(this.duplicates.add(t.sender,t.ID),debug&&console.log(t.type+" from "+e.remoteID+" by "+t.sender+" to "+t.destination),detailedDebug&&console.log(t),!t.destination||t.destination&&t.destination==this.legion.id?this.deliver(t,n,e):this.messagingProtocol.onMessage(e,t,n)))},MessagingAPI.prototype.deliver=function(e,t,n){if(this.callbacks.contains(e.type)){e.data=e.content;var o=this;try{decompress(e.data,function(s){e.data=JSON.parse(s),o.callbacks.get(e.type)(e,t,n)})}catch(s){o.callbacks.get(e.type)(e,t,n)}}else console.warn("can't deliver: no handler defined",JSON.stringify(e))},MessagingAPI.prototype.broadcastMessage=function(e,t){this.messagingProtocol.broadcastMessage(e,t)},MessagingAPI.prototype.sendTo=function(e,t){t.destination&&console.warn("Notice: message had a pre-defined destination!"),this.messagingProtocol.sendTo(e,t)},MessagingAPI.prototype.propagateToN=function(e,t){if(!e.N)return void console.error("NO N!");var n=this.legion.overlay.getPeers(e.N),o=0;n.length==e.N?e.N=1:o=e.N-n.length;for(var s=0;s<n.length;s++)if(0!=s||this.legion.bullyProtocol.amBullied())n[s].remoteID!=e.sender&&n[s].send(e);else{var i=JSON.parse(JSON.stringify(e));i.N=1+o,n[s].remoteID!=e.sender&&n[s].send(i)}if(!this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.isAlive()){var r=JSON.parse(JSON.stringify(e));r.N=1+o,this.legion.connectionManager.serverConnection.send(r)}},MessagingAPI.prototype.broadcast=function(e,t){var n=this;this.legion.generateMessage(e,t,function(e){n.broadcastMessage(e),n.deliver(e)})},MessagingAPI.prototype.setHandlerFor=function(e,t){this.callbacks.set(e,t)},"undefined"!=typeof exports&&(exports.ALQueue=ALQueue),ALQueue.prototype.size=function(){return this.queue.length},ALQueue.prototype.push=function(e){this.queue.push(e)},ALQueue.prototype.pop=function(){var e=this.queue[0];return this.queue=this.queue.slice(1),e},ALQueue.prototype.clear=function(){this.queue=[]},ObjectServerConnection.prototype.close=function(){this.socket.close()},ObjectServerConnection.prototype.send=function(e){"object"==typeof e&&(e=JSON.stringify(e)),this.socket.readyState==WebSocket.OPEN&&(console.log("Sent "+JSON.parse(e).type+" to "+this.remoteID+" s: "+JSON.parse(e).sender),this.socket.send(e))},"undefined"!=typeof exports&&(exports.ALSet=ALSet),ALSet.prototype.add=function(e){this.set[e]=!0},ALSet.prototype["delete"]=function(e){delete this.set[e]},ALSet.prototype.contains=function(e){return this.set[e]===!0},ALSet.prototype.size=function(){return Object.keys(this.set).length},ALSet.prototype.asArray=function(){return Object.keys(this.set)},ALSet.prototype.toJSONString=function(){return this.asArray()},ALSet.prototype.fromJSONString=function(e){if(this.set={},e)for(var t=0;t<e.length;t++)this.set[e[t]]=!0};var CRDT_LIB={};ObjectStore.prototype.checkIfMustHaveServer=function(){this.legion.bullyProtocol.amBullied()&&this.disconnectFromObjectServer()},ObjectStore.prototype.gotVVFromNetwork=function(e,t){var n=e.content.objectID,o=e.content.vv,s=this.crdts.get(n);if(!s)return void console.warn("Not implemented: vv for CRDT I do not have.");var i=s.versionVectorDiff(s.getVersionVector(),o),r=this;if(Object.keys(i.vv2.missing).length>0){objectsDebug&&console.log("Peer is missing ops.");var a=s.getOperations(i.vv2.missing),c={type:"OPLIST",objectID:n,operations:a};this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,c,function(t){if(t.destination=e.sender,r.objectServer&&t.destination==r.objectServer.peerConnection.remoteID)r.objectServer.send(t);else if(r.peerSyncs.contains(e.sender)){var n=r.peerSyncs.get(e.sender);n.send(t)}else r.legion.messagingAPI.sendTo(e.sender,t)})}Object.keys(i.vv1.missing).length>0&&(objectsDebug&&console.log("I am missing ops."),this.sendVVToNode(n,e.sender))},ObjectStore.prototype.sendVVToAll=function(e,t){var n=this.crdts.get(e),o={objectID:e,vv:n.getVersionVector()},s=this;this.legion.generateMessage(this.handlers.version_vector_propagation.type,o,function(e){s.legion.messagingAPI.broadcastMessage(e,[t,s.legion.connectionManager.serverConnection],!0)})},ObjectStore.prototype.sendVVToNode=function(e,t){var n=this.crdts.get(e),o={objectID:e,vv:n.getVersionVector()},s=this;this.legion.generateMessage(this.handlers.version_vector_propagation.type,o,function(e){if(e.destination=t,s.peerSyncs.contains(t)&&(s.peerSyncs.get(t).peerConnection.socket&&1==s.peerSyncs.get(t).peerConnection.socket.readyState||s.peerSyncs.get(t).peerConnection.channel&&"open"==s.peerSyncs.get(t).peerConnection.channel.readyState)){var n=s.peerSyncs.get(t);n.send(e)}else s.objectServer&&s.objectServer.peerConnection.remoteID==t?s.objectServer.send(e):s.legion.messagingAPI.sendTo(t,e)})},ObjectStore.prototype.onMessageFromServer=function(e,t,n){switch(e.type){case this.handlers.peerSync.type:return void this.objectServer.handleSync(e,t,n);case this.handlers.peerSyncAnswer.type:return void this.objectServer.handleSyncAnswer(e,t,n);case this.handlers.gotContentFromNetwork.type:return void this.handlers.gotContentFromNetwork.callback(e,t,n);case this.handlers.version_vector_propagation.type:return void this.handlers.version_vector_propagation.callback(e,t,n)}console.error("No typedef for: "+e)},ObjectStore.prototype.gotContentFromNetwork=function(e,t,n){switch(t.options||(t.options={}),t.options.except=n,e.content.type){case"OP":var o=e.content.objectID,s=this.crdts.get(o);s?s.operationsFromNetwork([e.content.msg],n,t):console.error("Got op for no crdt",e);break;case"OPLIST":var i=e.content.operations;i||(i=e.content.ops);var s=this.crdts.get(e.content.objectID);s.operationsFromNetwork(i,n,t);break;case"STATE":var o=e.content.objectID,s=this.crdts.get(o);s?s.stateFromNetwork(s.fromJSONString(e.content.msg.state),n,t):console.error("Got state for no crdt",e);break;case"DELTA":var o=e.content.objectID,s=this.crdts.get(o);s?s.deltaFromNetwork(e.content.msg,n,t):console.error("Got delta for no crdt",e);break;case"DELTAOPS":var o=e.content.objectID,s=this.crdts.get(o);s?s.deltaOPSFromNetwork(e.content,n,t):console.error("Got deltaOps for no crdt",e)}},ObjectStore.prototype.propagateMessage=function(e,t){e.extra=t,this.serverQueue.push(e),this.peersQueue.push(e)},ObjectStore.prototype.disconnectFromObjectServer=function(){this.objectServer&&this.objectServer.close()},ObjectStore.prototype.connectToObjectServer=function(){!this.objectServer&&this.legion.options.objectServerConnection&&new this.legion.options.objectServerConnection.type(this.legion.options.objectServerConnection.server,this,this.legion)},ObjectStore.prototype.useServerMessage=function(e,t){var n=this,o=t.options;if(o.onlyTo&&"string"!=typeof o.onlyTo&&(o.onlyTo=o.onlyTo.remoteID),o.except&&"string"!=typeof o.except&&(o.except=o.except.remoteID),!(o.except&&o.except==this.objectServer.peerConnection||o.except&&o.except==this.objectServer.peerConnection.remoteID))if(t.sender){if(t.extra){switch(t.extra.type){case"STATE":if(e.contains(""+t.objectID))return;e.set(""+t.objectID,!0)}delete t.extra}this.legion.generateMessage("Fake",{fake:"data"},function(e){n.objectServer.send(t)})}else{var s={};switch(t.type){case"OP":var i=t.objectID,r=t.clientID,a=t.operationID,c=this.crdts.get(i),l=c.getOpFromHistory(r,a);l.objectID=i,l.clientID=r,s=l;var u=""+i+r+a;if(e.contains(u))return;e.set(u,!0);break;case"OPLIST":break;case"STATE":var i=t.objectID,u=""+i;if(e.contains(u))return;e.set(u,!0);var c=this.crdts.get(i),h=c.toJSONString(c.getState());s={objectID:i,state:h};break;case"DELTA":var i=t.objectID,u=""+i;if(e.contains(u))return;e.set(u,!0);var c=this.crdts.get(i),p=c.getVersionVector(),g=c.getGCVV();s={objectID:i,vv:p,gcvv:g}}t.msg=s,this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,t,function(e){n.objectServer.send(e)})}},ObjectStore.prototype.clearServerQueue=function(){if(this.legion.bullyProtocol.amBullied())return this.serverQueue.size()>0&&(console.log("Clearing server queue. Am bullied."),this.serverQueue.clear()),void this.disconnectFromObjectServer();if(!this.objectServer)return console.log("Don't have a connection to objects server. Will try again soon."),void this.connectToObjectServer();if(this.serverQueue.size()>0){debug&&console.log("Messages in server queue: "+this.serverQueue.size());for(var e=this.serverQueue.pop(),t=new ALMap;e;)this.useServerMessage(t,e),e=this.serverQueue.pop()}},ObjectStore.prototype.usePeersMessage=function(e,t){var n=this,o=t.options;const s=o.except;if(o.onlyTo&&"string"!=typeof o.onlyTo&&(o.onlyTo=o.onlyTo.remoteID),o.except&&"string"!=typeof o.except&&(o.except=o.except.remoteID),t.sender){if(t.extra){switch(t.extra.type){case"STATE":if(e.contains(""+t.objectID))return;e.set(""+t.objectID,!0)}delete t.extra}this.legion.generateMessage("Fake",{fake:"data"},function(e){n.legion.messagingAPI.broadcastMessage(t,[n.legion.connectionManager.serverConnection],!0)})}else{var i={};switch(t.type){case"OP":var r=t.objectID,a=t.clientID,c=t.operationID,l=""+r+a+c;if(e.contains(l))return;e.set(l,!0);var u=this.crdts.get(r),h=u.getOpFromHistory(a,c);h.objectID=r,h.clientID=a,i=h;break;case"OPLIST":break;case"STATE":var r=t.objectID,l=""+r;if(e.contains(l))return;e.set(l,!0);var u=this.crdts.get(r),p=u.toJSONString(u.getState());i={objectID:r,state:p};break;case"DELTA":var r=t.objectID,l=""+r;if(e.contains(l))return;e.set(l,!0);var u=this.crdts.get(r),g=u.getVersionVector(),d=u.getGCVV();i={objectID:r,vv:g,gcvv:d}}t.msg=i,this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,t,function(e){const t=o.onlyTo;if(t)if(e.destination=t,n.peerSyncs.contains(t)){if(n.objectServer&&t==n.objectServer.remoteID)return;e.destination=t;var i=n.peerSyncs.get(t);i.send(e),console.log("Sent",e.type,"to",t)}else n.legion.messagingAPI.sendTo(t,e);else s?n.legion.messagingAPI.broadcastMessage(e,[s,n.legion.connectionManager.serverConnection],!0):n.legion.messagingAPI.broadcastMessage(e,[n.legion.connectionManager.serverConnection],!0);
})}},ObjectStore.prototype.clearPeersQueue=function(){if(this.peersQueue.size()>0){debug&&console.log("Messages in peers queue: "+this.peersQueue.size());for(var e=this.peersQueue.pop(),t=new ALMap;e;)this.usePeersMessage(t,e),e=this.peersQueue.pop()}},ObjectStore.prototype.defineCRDT=function(e){this.types.contains(e.type)?console.error("Can't redefine existing CRDT.",e):(this.types.set(e.type,e),Legion[e.type]=e.type)},ObjectStore.prototype.get=function(e,t,n){if(this.types.contains(t)){if(this.crdts.contains(e))return this.crdts.get(e);var o=this.types.get(t),s=new CRDT(e,o,this);return this.crdts.set(e,s),this.legion.bullyProtocol.amBullied()&&!n?(console.info("Send vv to "+this.legion.bullyProtocol.bully),this.sendVVToNode(e,this.legion.bullyProtocol.bully)):this.objectServer&&!n&&(console.info("Send vv to "+this.objectServer.peerConnection.remoteID),this.sendVVToNode(e,this.objectServer.peerConnection.remoteID)),s}console.error("No typedef found for CRDT.",t)},ObjectStore.prototype.propagate=function(e,t,n,o,s){var i={type:"OP",clientID:t,objectID:e,operationID:n,options:o,objectType:s};this.serverQueue.push(i),this.peersQueue.push(i)},ObjectStore.prototype.propagateAll=function(e,t,n){var o={type:"OPLIST",ops:t,objectID:e,options:n};this.serverQueue.push(o),this.peersQueue.push(o)},ObjectStore.prototype.onServerDisconnect=function(e){this.objectServer=null,this.serverQueue.clear()},ObjectStore.prototype.onServerConnection=function(e){this.objectServer=new PeerSync(this.legion,this,e),this.objectServer.sync()},ObjectStore.prototype.onClientConnection=function(e){var t=new PeerSync(this.legion,this,e);this.peerSyncs.set(e.remoteID,t),t.sync()},ObjectStore.prototype.onClientDisconnect=function(e){var t=this.peerSyncs.get(e.remoteID);t&&(this.peerSyncs["delete"](e.remoteID),t.finalize())},ObjectStore.prototype.propagateState=function(e,t){var n={type:"STATE",objectID:e,options:t};this.serverQueue.push(n),this.peersQueue.push(n)},ObjectStore.prototype.getCRDT=function(e){return this.crdts.get(e)},ObjectStore.prototype.propagateDelta=function(e,t){var n={type:"DELTA",objectID:e,options:t};this.serverQueue.push(n),this.peersQueue.push(n)},ObjectStore.prototype.sendDeltaOPSTo=function(e,t,n){var o={delta_ops:t,objectID:n.objectID,type:"DELTAOPS",vv:n.getVersionVector(),gcvv:n.getGCVV()},s=this;this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,o,function(t){if(s.objectServer&&e.remoteID==s.objectServer.remoteID)s.objectServer.send(t);else{var n=s.peerSyncs.get(e.remoteID);n.send(t)}})},"undefined"!=typeof exports&&(exports.compress=compress,exports.decompress=decompress,LZMA=require("./../../node_modules/lzma"));var fromDecToHex=function(e){if(e<0)return e=4294967295+e+1,e.toString(16).substring(6,8);var t=e.toString(16);return 1==t.length&&(t="0"+t),t},fromHexToDec=function(e){return parseInt(e,16)};Overlay.prototype.peerCount=function(){return this.peers.size()},Overlay.prototype.addPeer=function(e){this.peers.set(e.remoteID,e),this.overlayProtocol.onClientConnection(e),this.changedOverlay()},Overlay.prototype.removePeer=function(e){this.peers["delete"](e.remoteID),this.overlayProtocol.onClientDisconnect(e),this.changedOverlay()},Overlay.prototype.onServerDisconnect=function(e){this.overlayProtocol.onServerDisconnect(e),this.changedOverlay()},Overlay.prototype.onServerConnection=function(e){this.overlayProtocol.onServerConnection(e),this.changedOverlay()},Overlay.prototype.changedOverlay=function(e){var t=this.peers.keys(),n=[];this.legion.bullyProtocol.amBullied()||(n.push("SignallingServer"),n.push("ObjectServer")),this.onChangeCallback&&this.onChangeCallback(e,t,n)},Overlay.prototype.setOnChange=function(e){this.onChangeCallback=e},Overlay.prototype.getPeers=function(e){if(e||(e=this.peerCount()),e=parseInt(e),e==this.peerCount)return this.peers.values();var t=this.shuffle(this.peers.values());return t.slice(0,e)},Overlay.prototype.shuffle=function(e){var t,n,o=e.length;if(o)for(;--o;)n=Math.floor(Math.random()*(o+1)),t=e[n],e[n]=e[o],e[o]=t;return e},"undefined"!=typeof exports&&(exports.Duplicates=Duplicates),Duplicates.prototype.add=function(e,t){this.senders[e]||(this.senders[e]=new RangeSet),this.senders[e].add(t)},Duplicates.prototype.contains=function(e,t){return!!this.senders[e]&&this.senders[e].contains(t)},Duplicates.prototype.print=function(){for(var e=Object.keys(this.senders),t=0;t<e.length;t++)console.log(e[t]),this.senders[e[t]].print()},RangeSet.prototype.add=function(e){for(var t=this.pairs.length-1;t>=0;t--){if(e>=this.pairs[t].first&&e<=this.pairs[t].last)return;if(e==this.pairs[t].last+1){for(this.pairs[t].last+=1;this.pairs[t-1]&&this.pairs[t].last==this.pairs[t-1].first-1;)this.pairs[t].last=this.pairs[t-1].last,this.pairs.splice(t-1,1),t--;return}if(e==this.pairs[t].first-1)return void(this.pairs[t].first-=1);if(e<this.pairs[t].first)return void this.pairs.splice(t+1,0,{first:e,last:e})}this.pairs.splice(0,0,{first:e,last:e})},RangeSet.prototype.contains=function(e){for(var t=0;t<this.pairs.length;t++)if(e>=this.pairs[t].first&&e<=this.pairs[t].last)return!0;return!1},RangeSet.prototype.print=function(){for(var e=0;e<this.pairs.length;e++)console.log(this.pairs[e].first+" : "+this.pairs[e].last)};var DEFAULT_PEER_INIT_TIMEOUT=15e3,KEEP_ALIVE_INTERVAL=1e4,KEEP_ALIVE_MESSAGE={type:"ka"},KEEP_ALIVE_MUST_HAVE=3e4;PeerConnection.prototype.keepAlive=function(){this.lastKeepAlive+KEEP_ALIVE_MUST_HAVE<Date.now()?(console.warn("Peer "+this.legion.id+" keepAlive timeout from "+this.remoteID+"."),this.isAlive()&&this.channel.close(),clearInterval(this.keepAliveInterval)):this.send(KEEP_ALIVE_MESSAGE)},PeerConnection.prototype.onInitTimeout=function(){console.warn("Peer "+this.legion.id+" connection timeout before getting offer from "+this.remoteID+"."),this.cancelAll(!0)},PeerConnection.prototype.setChannelHandlers=function(){var e=this;this.channel.onmessage=function(t){var n=e.legion.secure.decipher(t.data,e,t);if(n!==!0){var o=JSON.parse(n);if(o.type==KEEP_ALIVE_MESSAGE.type)return void(e.lastKeepAlive=Date.now());var s=JSON.parse(n);if(o.content)try{decompress(o.content,function(t){o.content=JSON.parse(t),e.legion.messagingAPI.onMessage(e,o,s)})}catch(i){console.error(t),console.error(n),console.error(o),console.error(s),console.error(i)}else decompress("5d00000100040000000000000000331849b7e4c02e1ffffac8a000",function(t){e.legion.messagingAPI.onMessage(e,o,s)})}},this.channel.onopen=function(t){clearTimeout(e.init_timeout),e.legion.connectionManager.onOpenClient(e)},this.channel.onclose=function(t){e.legion.connectionManager.onCloseClient(e),clearInterval(this.keepAliveInterval)}},PeerConnection.prototype.cancelAll=function(e){var t=this;e||this.channel&&(this.channel.onclose=function(){console.log("Forced a channel close for duplicate PeerConnection.",t.legion.id,t.remoteID)}),this.channel=null,this.peer.close(),clearTimeout(this.init_timeout),clearInterval(this.keepAliveInterval),this.peer=null,this.legion.connectionManager.onCloseClient(this)},PeerConnection.prototype.returnOffer=function(e){detailedDebug&&console.log(e),this.peer.setRemoteDescription(new RTCSessionDescription(e))},PeerConnection.prototype.return_ice=function(e){detailedDebug&&console.log(e);var t=this;this.peer.addIceCandidate(new RTCIceCandidate(e),function(){},function(n){console.warn("onAddIceCandidateError",t.legion.id,t.remoteID,n,e)})},PeerConnection.prototype.onicecandidate=function(e){e.candidate&&(console.info(e.candidate),this.legion.connectionManager.sendICE(e.candidate,this.unique,this))},PeerConnection.prototype.close=function(){this.cancelAll(!0)},PeerConnection.prototype.startLocal=function(){debug&&console.log("start local: "+this.remoteID);var e=this;this.channel=this.peer.createDataChannel("sendDataChannel",dataConstraint),this.unique=this.legion.randInt(),this.setChannelHandlers(),this.peer.onicecandidate=function(t){e.onicecandidate(t)},this.peer.createOffer(function(t){console.info(t),e.peer.setLocalDescription(t),e.legion.connectionManager.sendStartOffer(t,e.unique,e)},function(t){console.error("onCreateSessionDescriptionError",t),e.onclose()})},PeerConnection.prototype.startRemote=function(e,t){this.unique=t,detailedDebug&&console.log(e),debug&&console.log("start remote: "+this.remoteID),this.peer.setRemoteDescription(new RTCSessionDescription(e));var n=this;this.peer.ondatachannel=function(e){n.channel=e.channel,n.setChannelHandlers()},this.peer.onicecandidate=function(e){n.onicecandidate(e)},this.peer.createAnswer(function(e){n.peer.setLocalDescription(e),n.legion.connectionManager.sendReturnOffer(e,n.unique,n)},function(e){console.error("onCreateSessionDescriptionError",e),n.onclose()})},PeerConnection.prototype.isAlive=function(){return this.channel&&"open"==this.channel.readyState},PeerConnection.prototype.setMeta=function(e){this.meta=e},PeerConnection.prototype.getMeta=function(){return this.meta},PeerConnection.prototype.send=function(e){if("object"==typeof e&&(e=JSON.stringify(e)),this.channel&&"open"==this.channel.readyState){var t=this.legion.secure.cipher(e);this.channel&&"open"==this.channel.readyState?this.channel.send(t):console.warn("Peer has no open channel.")}else console.warn("Peer has no open channel.")};var servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]},pcConstraint={optional:[{RtpDataChannels:!1}]},dataConstraint=null;"undefined"!=typeof exports&&(CRDT_Database=!0,exports.CRDT=CRDT);var crtd_type={type:"crdtType",propagation:1,crdt:{base_value:function(){},getValue:function(){},operations:{},merge:function(e,t){},compare:function(e,t){},fromJSONString:function(e){},toJSONString:function(e){},garbageCollect:function(e){},getDelta:function(e){},applyDelta:function(e,t,n){}}};CRDT.STATE_BASED=1,CRDT.OP_BASED=2,CRDT.DELTA_BASED=3,CRDT.STATE=Object.freeze({COMPARE_RESPONSE:{EQUALS:1,LOWER:2,HIGHER:3,MUST_MERGE:4}}),CRDT.prototype.addOpToCurrentVersionVector=function(e,t){this.versionVector.set(e,t)},CRDT.prototype.addOpToHistory=function(e,t,n,o,s){var i=this.opHistory.get(e);i||(i=new ALMap,this.opHistory.set(e,i)),i.set(t,{dependencyVV:s,opID:t,result:n,opName:o})},CRDT.prototype.getOpFromHistory=function(e,t){var n=this.opHistory.get(e);if(n)return n.get(t)},CRDT.prototype.getState=function(){return this.state},CRDT.prototype.setOnStateChange=function(e){this.callback=e},CRDT.prototype.getOperations=function(e){for(var t=[],n=Object.keys(e),o=0;o<n.length;o++)for(var s=n[o],i=e[s],r=0;r<i.length;r++){var a=i[r],c=this.getOpFromHistory(s,a);c.clientID=s,t.push(c)}return t},CRDT.prototype.getVersionVector=function(){for(var e=this.versionVector.keys(),t={},n=0;n<e.length;n++)t[e[n]]=this.versionVector.get(e[n]);return t},CRDT.prototype.getGCVV=function(){return this.gcvv},CRDT.prototype.stateFromNetwork=function(e,t,n){var o=this.compare(this.getState(),e);switch(console.log("From network: "+o),o){case CRDT.STATE.COMPARE_RESPONSE.EQUALS:break;case CRDT.STATE.COMPARE_RESPONSE.LOWER:this.objectStore.propagateState(this.objectID,{onlyTo:t});break;case CRDT.STATE.COMPARE_RESPONSE.HIGHER:var s=this.merge(this.getState(),e);this.state=s.mergeResult,this.callback&&this.callback(s.stateChange,{local:!1}),n?(n.options={except:t.remoteID},this.objectStore.propagateMessage(n,{type:"STATE",objectID:this.objectID})):this.objectStore.propagateState(this.objectID,{except:t});break;case CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE:var s=this.merge(this.getState(),e);this.state=s.mergeResult,this.callback&&this.callback(s.stateChange,{local:!1}),this.objectStore.propagateState(this.objectID,{all:!0})}},CRDT.prototype.deltaFromNetwork=function(e,t,n){objectsDebug&&console.error("deltaFromNetwork");var o=e.vv,s=Object.keys(o),i=this.getDelta(o,e.gcvv);i.has&&(objectsDebug&&console.info(i),this.objectStore.sendDeltaOPSTo(t,i,this));for(var r=0;r<s.length;r++){if(!this.versionVector.contains(s[r])){objectsDebug&&console.info("pd"),this.objectStore.propagateDelta(this.objectID,{all:!0});break}if(this.versionVector.get(s[r])<o[s[r]]){objectsDebug&&console.info("pd"),this.objectStore.propagateDelta(this.objectID,{all:!0});break}}},CRDT.prototype.deltaOPSFromNetwork=function(e,t,n){objectsDebug&&console.error("deltaOPSFromNetwork"),objectsDebug&&console.error(e),objectsDebug&&console.error(t),objectsDebug&&console.error(n),this.applyDelta(e.delta_ops,e.vv,e.gcvv),this.garbageCollect(e.gcvv);for(var o=Object.keys(e.vv),s=0;s<o.length;s++){var i=o[s];this.versionVector.contains(i)?this.versionVector.set(i,Math.max(e.vv[i],this.versionVector.get(i))):this.versionVector.set(i,e.vv[i])}},CRDT.prototype.operationsFromNetwork=function(e,t,n){for(var o=[],s=[],i=[],r=0,a=e.length;e.length>0;){for(var c=!1;r<e.length;){var l=e[r];if(l.dependencyVV)if(this.alreadyHadOp(l))i.push(l),e.splice(r,1),c=!0;else if(this.depsMatchedFor(l)){var u=this.remotes[l.opName].apply(this,[l.result]);this.addOpToHistory(l.clientID,l.opID,l.result,l.opName,l.dependencyVV),this.addOpToCurrentVersionVector(l.clientID,l.opID),o.push(u),s.push(l),e.splice(r,1),c=!0}else r++;else r++}if(!c){this.objectStore.sendVVToNode(this.objectID,t.remoteID);break}r=0}if(i.length>0,o.length>0&&this.callback)for(var h=0;h<o.length;h++)this.callback(o[h],{local:!1});s.length==a?n?(n.options={except:t.remoteID},this.objectStore.propagateMessage(n)):this.objectStore.propagateAll(this.objectID,s,{except:t}):s.length>0&&this.objectStore.propagateAll(this.objectID,s,{except:t})},CRDT.prototype.depsMatchedFor=function(e){for(var t=e.dependencyVV,n=Object.keys(t),o=0;o<n.length;o++)if(!this.alreadyHadOperation(n[o],t[n[o]]))return!1;return!0},CRDT.prototype.alreadyHadOp=function(e){return this.alreadyHadOperation(e.clientID,e.opID)},CRDT.prototype.alreadyHadOperation=function(e,t){return!!this.versionVector.contains(e)&&t<=this.versionVector.get(e)},CRDT.prototype.versionVectorDiff=function(e,t){for(var n={vv1:{missing:{}},vv2:{missing:{}}},o=Object.keys(e),s=Object.keys(t),i=0;i<o.length;i++){var r=o[i];if(t[r]){if(t[r]>e[r]){n.vv1.missing[r]=[];for(var a=e[r]+1;a<=t[r];a++)n.vv1.missing[r].push(a)}}else{n.vv2.missing[r]=[];for(var a=1;a<=e[r];a++)n.vv2.missing[r].push(a)}}for(var c=0;c<s.length;c++){var r=s[c];if(e[r]){if(e[r]>t[r]){n.vv2.missing[r]=[];for(var a=t[r]+1;a<=e[r];a++)n.vv2.missing[r].push(a)}}else{n.vv1.missing[r]=[];for(var a=1;a<=t[r];a++)n.vv1.missing[r].push(a)}}return n},ServerConnection.prototype.close=function(){this.socket.close()},ServerConnection.prototype.isAlive=function(){return this.socket&&this.socket.readyState==WebSocket.OPEN},ServerConnection.prototype.send=function(e){e.N,"object"==typeof e&&(e=JSON.stringify(e)),this.socket.readyState==WebSocket.OPEN&&(console.log("Sent "+JSON.parse(e).type+" to "+this.remoteID+" s: "+JSON.parse(e).sender),this.socket.send(e))},"undefined"!=typeof exports&&(exports.PeerSync=PeerSync,ALMap=require("./ALMap.js"),ALMap=ALMap.ALMap,ALQueue=require("./ALQueue.js"),ALQueue=ALQueue.ALQueue),PeerSync.prototype.close=function(){this.peerConnection.close(),this.finalize()},PeerSync.prototype.send=function(e){"object"==typeof e&&(e=JSON.stringify(e)),this.isSynced&&0==this.queueAfterSync.size()?this.peerConnection.send(e):this.queueAfterSync.push(e)},PeerSync.prototype.finalize=function(){this.isSynced=!1,this.peerConnection=null,this.queueAfterSync.clear(),this.queueAfterSync=null,this.sharedObjects.clear(),this.sharedObjects=null,clearTimeout(this.psTimeout)},PeerSync.prototype.clearQueue=function(){if(this.isSynced){var e=this.queueAfterSync.pop();for(e&&console.log("Clearing queue to: "+this.peerConnection.remoteID+". Size of queue: "+(this.queueAfterSync.size()+1));"undefined"!=typeof e;)this.peerConnection.send(e),e=this.queueAfterSync.pop()}else console.error("Clearing queue before sync.")},PeerSync.prototype.handleSyncAnswer=function(e){for(var t=e.content.states,n=e.content.missing_ops,o=0;o<t.length;o++){var s=this.objectStore.getCRDT(t[o].id,t[o].type);s?s.stateFromNetwork(s.fromJSONString(t[o].state),this.peerConnection):console.log("I should not be here.")}for(var i=0;i<n.length;i++){var r=this.objectStore.getCRDT(n[i].id,n[i].type);r?r.operationsFromNetwork(n[i].operations,this.peerConnection):console.log("I should not be here.")}clearTimeout(this.psTimeout),this.isSynced=!0,this.clearQueue()},PeerSync.prototype.handleSync=function(e){for(var t=e.content.stateObjects,n=e.content.operationObjects,o={missing_ops:[],states:[]},s=0;s<n.length;s++){var i=this.objectStore.getCRDT(n[s].id,n[s].type);if(i){var r=i.getVersionVector(),a=i.versionVectorDiff(r,n[s].vv);Object.keys(a.vv2.missing).length>0&&o.missing_ops.push({id:i.objectID,operations:i.getOperations(a.vv2.missing)})}}for(var c=0;c<t.length;c++){var l=this.objectStore.getCRDT(t[c].id,t[c].type);l&&o.states.push({id:l.objectID,state:l.toJSONString(l.getState())})}var u=this;this.legion.generateMessage(this.objectStore.handlers.peerSyncAnswer.type,o,function(e){e.destination=u.peerConnection.remoteID,u.peerConnection.send(JSON.stringify(e))})},PeerSync.prototype.sync=function(){for(var e=this,t={stateObjects:[],operationObjects:[]},n=this.objectStore.crdts.keys(),o=0;o<n.length;o++){var s=this.objectStore.getCRDT(n[o]);s.crdt.propagation==CRDT.STATE_BASED?t.stateObjects.push({id:s.objectID,type:s.crdt.type}):s.crdt.propagation==CRDT.OP_BASED?t.operationObjects.push({id:s.objectID,vv:s.getVersionVector(),type:s.crdt.type}):s.crdt.propagation==CRDT.DELTA_BASED?console.warn("Not implemented yet."):console.error("Shit happened.")}this.legion.generateMessage(this.objectStore.handlers.peerSync.type,t,function(t){t.destination=e.peerConnection.remoteID,"undefined"!=typeof CRDT_Database&&console.log("Send "+t.type+" to "+e.peerConnection.remoteID+" s: "+t.sender),e.peerConnection.send(JSON.stringify(t))})},CliquesOverlay.prototype.onClientConnection=function(e){this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.socket.close(),this.floodJoin()},CliquesOverlay.prototype.onClientDisconnect=function(e){},CliquesOverlay.prototype.onServerConnection=function(e){this.init()},CliquesOverlay.prototype.onServerDisconnect=function(e){},CliquesOverlay.prototype.init=function(e){this.floodJoin()},CliquesOverlay.prototype.floodJoin=function(){if(!this.started){var e=this.legion.connectionManager.serverConnection;e||this.legion.bullyProtocol.amBullied()||this.legion.connectionManager.startSignallingConnection(),this.started=!0}var t=this;this.legion.generateMessage("Connect",null,function(e){t.legion.messagingAPI.broadcastMessage(e)})},CliquesOverlay.prototype.handleJoin=function(e,t,n){this.legion.connectionManager.hasPeer(e.sender)||this.overlay.peerCount()<=1&&this.legion.connectionManager.connectPeer(e.sender),this.legion.messagingAPI.broadcastMessage(t,[n]),this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.close()},"undefined"!=typeof exports&&(exports.DS_DLList=DS_DLList),DS_DLList.prototype.size=function(){return this.count},DS_DLList.prototype.isEmpty=function(){return 0==this.size()},DS_DLList.prototype.addFirst=function(e){var t=new DS_DLL_Node(e);this.isEmpty()?this.head=this.tail=t:(t.next=this.head,this.head&&(this.head.previous=t),this.head=t),this.count++},DS_DLList.prototype.addLast=function(e){var t=new DS_DLL_Node(e);this.isEmpty()?(this.head=t,this.tail=t):(t.previous=this.tail,this.tail&&(this.tail.next=t),this.tail=t),this.count++},DS_DLList.prototype.getFirst=function(){return this.isEmpty()?void 0:this.head.element},DS_DLList.prototype.getLast=function(){return this.isEmpty()?void 0:this.tail.element},DS_DLList.prototype.removeFirst=function(){if(!this.isEmpty()){var e=this.head;this.head=e.next,this.head instanceof DS_DLL_Node&&(this.head.previous=null);var t=e.element;return this.count--,t}},DS_DLList.prototype.removeLast=function(){if(!this.isEmpty()){var e=this.tail;this.tail=e.previous,this.tail instanceof DS_DLL_Node&&(this.tail.next=null);var t=e.element;return this.count--,t}},SecurityProtocol.prototype.gotServerAuthenticationResult=function(e){if(console.log(e),"Success"==e.result)for(this.keys.set(e.currentKey.id,e.currentKey),this.currKey=e.currentKey.id,this.serverPublicKey=forge.pki.publicKeyFromAsn1(JSON.parse(e.serverPublicKey));!this.queue.isEmpty;){var t=this.queue.removeFirst();t.pc.channel.onmessage({data:t.msg})}else console.error("Security check failed.")},SecurityProtocol.prototype.getServerAuthenticationChallenge=function(){var e={};return e.type="Auth",e.client_id=this.legion.id,e.clientChallenge=this.legion.id,JSON.stringify(e)},SecurityProtocol.prototype.verifySHB=function(e){var t=e.signature;if(e.ID>=this.getCurrentKeyID()&&Date.now()-(e.timestamp+e.validity)<=0){var n=forge.md.sha256.create();return n.update(""+e.timestamp+e.ID+e.KeyID+e.validity),this.serverPublicKey.verify(n.digest().bytes(),t)}return!1},SecurityProtocol.prototype.getCurrentKeyID=function(){return this.currKey},SecurityProtocol.prototype.cipher=function(e){var t=this.keys.get(this.getCurrentKeyID()),n=forge.cipher.createCipher("AES-CBC",t.key);return n.start({iv:t.iv}),n.update(forge.util.createBuffer(e)),n.finish(),"7."+t.id+".7:"+n.output.bytes()},SecurityProtocol.prototype.decipher=function(e,t,n){if("7"==e[0]||"."==e[1]){var o;for(o=2;"."!=e[o];o++);var s=parseInt(e.substring(2,o));if(!(s<this.getCurrentKeyID())){if(s>this.getCurrentKeyID())return this.queue.addLast({msg:n,pc:t}),this.legion.join(),!0;var i=this.keys.get(s),r=e.substring(o+3),a=forge.cipher.createDecipher("AES-CBC",i.key);return a.start({iv:i.iv}),a.update(forge.util.createBuffer(r)),a.finish(),a.output.data}}},"undefined"!=typeof exports&&(exports.DS_TableList=DS_TableList),DS_TableList.prototype.size=function(){return this.list.length},DS_TableList.prototype.asArray=function(){return this.list},DS_TableList.prototype.put=function(e,t){this.list=this.list.slice(0,e).concat(t).concat(this.list.slice(e,this.size()))},DS_TableList.prototype.remove=function(e){var t=this.list[e];if(t)return this.list=this.list.slice(0,e).concat(this.list.slice(e+1,this.size())),t},DS_TableList.prototype.get=function(e){if(e>=0&&e<this.list.length)return this.list[e]},B2BOverlay.prototype.onClientConnection=function(e){var t=this;this.legion.generateMessage("P2PMeta",null,function(n){n.meta={server:!t.legion.bullyProtocol.amBullied(),peers:t.legion.overlay.peerCount()},e.send(n)}),setTimeout(function(){t.checkIfMustHaveServer()},2e3)},B2BOverlay.prototype.checkIfMustHaveServer=function(){this.legion.bullyProtocol.amBullied()?this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.close():this.legion.connectionManager.serverConnection||this.legion.connectionManager.startSignallingConnection()},B2BOverlay.prototype.onClientDisconnect=function(e){},B2BOverlay.prototype.onServerConnection=function(e){this.init(e)},B2BOverlay.prototype.onServerDisconnect=function(e){},B2BOverlay.prototype.init=function(e){var t=this;this.overlay.peerCount()>this.min||(0==this.overlay.peerCount()?this.legion.generateMessage("JoinRequest",null,function(n){n.N=t.initial_n,n.TTL=t.initial_ttl,e.send(n)}):this.legion.generateMessage("JoinRequest",null,function(n){n.N=t.max-t.overlay.peerCount(),n.TTL=t.initial_ttl,e.send(n)}))},B2BOverlay.prototype.onJoinRequest=function(e,t,n){if(this.overlay.peers.contains(e.sender))e.TTL--,e.N>0&&e.TTL>0&&this.legion.messagingAPI.propagateToN(e);else{var o=!1;if(this.overlay.peerCount()<this.min?o=!0:0!=e.TTL&&n instanceof PeerConnection?this.overlay.peerCount()<this.max&&(this.legion.bullyProtocol.amBullied()&&Math.random()<1-this.RAND_VAL?o=!0:!this.legion.bullyProtocol.amBullied()&&Math.random()<this.RAND_VAL&&(o=!0)):o=!0,o){var s=this;this.legion.generateMessage("JoinAnswer",null,function(t){t.destination=e.sender,n.isAlive()?n.send(t):s.legion.messagingAPI.broadcastMessage(t)})}o&&e.N--,e.TTL--,e.N>0&&e.TTL>0&&n instanceof PeerConnection&&this.legion.messagingAPI.propagateToN(e)}},B2BOverlay.prototype.onJoinAnswer=function(e,t,n){this.overlay.peers.contains(e.sender)||this.legion.connectionManager.connectPeer(e.sender)},B2BOverlay.prototype.removeBestPeer=function(){var e=this.getBestPeer();e||(e=this.overlay.getPeers(1),e.length()>0&&(e=e[0])),e.close()},B2BOverlay.prototype.getBestPeer=function(){for(var e=null,t=null,n=this.overlay.getPeers(this.overlay.peerCount()),o=0;o<n.length;o++)t?this.isBetterMeta(n[o].meta,t)&&(t=n[o].meta,e=n[o]):(t=n[o].meta,e=n[o]);return e},B2BOverlay.prototype.isBetterMeta=function(e,t){return!!e&&(!t||(e.peers>t.peers||e.server<t.server))},B2BOverlay.prototype.sendP2PMeta=function(){var e=this;this.legion.generateMessage("P2PMeta",null,function(t){t.meta={server:!e.legion.bullyProtocol.amBullied(),peers:e.legion.overlay.peerCount()},e.legion.messagingAPI.broadcastMessage(t,[e.legion.connectionManager.serverConnection])})},B2BOverlay.prototype.gotP2PMeta=function(e,t,n){n.setMeta(e.meta)};var bullyLog=!0;ServerBully.prototype.setOnBullyCallback=function(e){this.callbacks.push(e)},ServerBully.prototype.bullied=function(){for(var e=this.amBullied(),t=0;t<this.callbacks.length;t++)this.callbacks[t](e)},ServerBully.prototype.onClientConnection=function(e){e.remoteID>this.legion.id&&this.lastSHB&&("undefined"!=typeof bullyLog&&bullyLog&&console.log("Being immediate bully to",e.remoteID),this.lastSHB&&e.send(this.lastSHB))},ServerBully.prototype.onClientDisconnect=function(e){},ServerBully.prototype.onServerConnection=function(e){},ServerBully.prototype.onServerDisconnect=function(e){},ServerBully.prototype.amBullied=function(){if(this.bully==this.legion.id.toString()||"TEMP_ID"==this.bully||!this.lastSHB)return!1;var e=Date.now()-(this.lastSHB.timestamp+this.lastSHB.validity);return e<=0},ServerBully.prototype.floodBully=function(){if(this.amBullied())"undefined"!=typeof bullyLog&&bullyLog&&console.log("My bully",this.bully,this.lastBullyMessage);else{this.bullied(),this.bully=this.legion.id.toString();for(var e=this,t=e.legion.overlay.getPeers(e.legion.overlay.peerCount()),n=0;n<t.length;n++)"undefined"!=typeof bullyLog&&bullyLog&&console.log("Being bully to",t[n].remoteID),t[n].send(this.lastSHB)}},SimpleBully.prototype.setOnBullyCallback=function(e){this.callbacks.push(e)},SimpleBully.prototype.bullied=function(){for(var e=this.amBullied(),t=0;t<this.callbacks.length;t++)this.callbacks[t](e)},SimpleBully.prototype.onClientConnection=function(e){e.remoteID>this.legion.id&&this.legion.generateMessage(this.handlers.bully.type,null,function(t){"undefined"!=typeof bullyLog&&bullyLog&&console.log("Being immediate bully to",e.remoteID),e.send(t)})},SimpleBully.prototype.onClientDisconnect=function(e){},SimpleBully.prototype.onServerConnection=function(e){this.amBullied()||this.floodBully()},SimpleBully.prototype.onServerDisconnect=function(e){},SimpleBully.prototype.amBullied=function(){if(this.bully==this.legion.id.toString()||"TEMP_ID"==this.bully)return!1;var e=Date.now()-this.lastBullyMessage;return e<=this.bullyMustHaveInterval},SimpleBully.prototype.floodBully=function(){if(this.amBullied())"undefined"!=typeof bullyLog&&bullyLog&&console.log("My bully",this.bully,this.lastBullyMessage);else{this.bullied(),this.bully=this.legion.id.toString(),this.lastBullyMessage=Date.now();var e=this;this.legion.generateMessage(this.handlers.bully.type,null,function(t){for(var n=e.legion.overlay.getPeers(e.legion.overlay.peerCount()),o=0;o<n.length;o++)"undefined"!=typeof bullyLog&&bullyLog&&console.log("Being bully to",n[o].remoteID),n[o].send(t)})}},FloodMessaging.prototype.onMessage=function(e,t,n){(!t.destination||t.destination&&t.destination!=this.legion.id)&&(e instanceof PeerConnection?this.broadcastMessage(n,[e]):debug&&console.log("Not broadcasting: "+t.type,this.legion.id,t.sender))},FloodMessaging.prototype.sendTo=function(e,t){t.destination=e,this.broadcastMessage(t,[this.legion.connectionManager.serverConnection])},FloodMessaging.prototype.broadcastMessage=function(e,t,n){var o=this.legion.overlay.getPeers(this.legion.overlay.peerCount());if(e.destination)for(var s=0;s<o.length;s++)if(o[s].remoteID==e.destination)return void o[s].send(e);var i=o.length;n&&(i=2);for(var r=0,s=0;r<i&&s<o.length;s++)if(o[s].remoteID!=e.sender){for(var a=!0,c=0;a&&t&&c<t.length;c++)t[c]&&o[s].remoteID==t[c].remoteID&&(a=!1);a&&(o[s].send(e),r++)}var l=this.legion.connectionManager.serverConnection;if(l){for(var s=0;t&&s<t.length;s++)if(t[s]&&l.remoteID==t[s].remoteID)return;l.send(e)}},SimpleOverlay.prototype.onClientConnection=function(e){this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.socket.close(),this.floodJoin()},SimpleOverlay.prototype.onClientDisconnect=function(e){},SimpleOverlay.prototype.onServerConnection=function(e){this.init()},SimpleOverlay.prototype.onServerDisconnect=function(e){},SimpleOverlay.prototype.init=function(e){this.floodJoin()},SimpleOverlay.prototype.floodJoin=function(){this.overlay.getPeers(this.overlay.peerCount());if(!this.started){var e=this.legion.connectionManager.serverConnection;e||this.legion.bullyProtocol.amBullied()||this.legion.connectionManager.startSignallingConnection(),this.started=!0}var t=this;this.legion.generateMessage("ConnectToAnyNodesPlease",null,function(e){t.legion.messagingAPI.broadcastMessage(e)})},SimpleOverlay.prototype.handleJoin=function(e,t,n){this.legion.connectionManager.hasPeer(e.sender)||this.overlay.peerCount()<=1&&this.legion.connectionManager.connectPeer(e.sender),this.legion.messagingAPI.broadcastMessage(t,[n]),this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.close()},"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var delta_counter={type:"DELTA_Counter",propagation:CRDT.DELTA_BASED,crdt:{base_value:{state:{dec:ALMap,inc:ALMap}},getValue:function(){for(var e=0,t=this.state.dec.keys(),n=this.state.inc.keys(),o=0;o<t.length;o++)e-=this.state.dec.get(t[o]);for(var s=0;s<n.length;s++)e+=this.state.inc.get(n[s]);return e},operations:{increment:function(e,t){return t||(t=e,e=this.objectStore.legion.id),this.state.inc.contains(e)||this.state.inc.set(e,0),this.state.inc.set(e,this.state.inc.get(e)+t),t},decrement:function(e,t){return t||(t=e,e=this.objectStore.legion.id),this.state.dec.contains(e)||this.state.dec.set(e,0),this.state.dec.set(e,this.state.dec.get(e)+t),-t}},garbageCollect:function(e){},getDelta:function(e,t){for(var n={has:!1,incs:[],decs:[]},o=Object.keys(e),s=0;s<o.length;s++)before({id:o[s],o:e[o[s]]},this.versionVector)&&(n.has=!0,n.incs.push({id:o[s],value:this.state.inc.get(o[s])}),n.decs.push({id:o[s],value:this.state.dec.get(o[s])}));return n},applyDelta:function(e,t,n){var o=e.incs,s=e.decs;objectsDebug&&console.log("applyDelta"),objectsDebug&&console.log(e),objectsDebug&&console.log(t),objectsDebug&&console.log(n);for(var i=0;i<o.length;i++){var r=o[i];this.state.incs.set(r.id,Math.max(this.state.incs.get(r.id),r.value))}for(var a=0;a<s.length;a++){var r=s[a];this.state.decs.set(r.id,Math.max(this.state.decs.get(r.id),r.value))}}}};"undefined"!=typeof exports?exports.DELTA_Counter=delta_counter:CRDT_LIB.DELTA_Counter=delta_counter;var before=function(e,t){return t instanceof ALMap?!!t.contains(e.id)&&t.get(e.id)>e.o:!!t[e.id]&&t[e.id]>e.o},after=function(e,t){return t instanceof ALMap?!t.contains(e.id)||t.get(e.id)<e.o:!t[e.id]||t[e.id]<e.o};"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var TOMBSTONE_THRESHOLD=10,delta_set={type:"DELTA_Set",propagation:CRDT.DELTA_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){return this.state.adds.keys()},operations:{add:function(e,t){if(objectsDebug&&console.warn("add",e,t,arguments),!this.state.adds.contains(e)){this.state.adds.set(e,new ALMap);
var n=this.state.adds.get(e);return n.set(t,!0),{add:e}}},remove:function(e,t){var n=null,o=this.state.adds.get(e);if(o){for(var s={element:e,removes:o.keys()},i=0;i<s.removes.length;i++)this.state.removes.set(t,s.removes[i]),o["delete"](s.removes[i]);0==o.size()&&(this.state.adds["delete"](s.element),n={remove:s.element})}if(this.state.removes.size()>=TOMBSTONE_THRESHOLD){for(var r={},a=this.getVersionVector(),c=Object.keys(a),i=0;i<c.length;i++)a[c[i]]>3&&(r[c[i]]=a[c[i]]-3);console.info(r),this.garbageCollect(r)}return n}},garbageCollect:function(e){for(var t=this.state.removes.keys(),n=0;n<t.length;n++){var o=this.state.removes.get(t[n]);(before(o,e)||before(JSON.parse(t[n]),e))&&this.state.removes["delete"](t[n])}for(var s=Object.keys(e),n=0;n<s.length;n++){var i=s[n];this.gcvv[i]?this.gcvv[i]=Math.max(e[i],this.gcvv[i]):this.gcvv[i]=e[i]}},getDelta:function(e,t){for(var n={has:!1,adds:[],removes:[]},o=!1,s=Object.keys(e),i=0;i<s.length;i++)if(before({id:s[i],o:e[s[i]]},this.gcvv)){console.warn("from < gcvv"),o=!0;break}for(var r=this.state.adds.keys(),a=0;a<r.length;a++)for(var c=this.state.adds.get(r[a]),l=c.keys(),u=0;u<l.length;u++){var h=JSON.parse(l[u]);(1==o||after(h,e))&&(n.adds.push({key:r[a],u:h}),n.has=!0)}for(var p=this.state.removes.keys(),g=0;g<p.length;g++){var d=this.state.removes.get(p[g]);(1==o||after(d,e)||after(JSON.parse(p[g]),e))&&(n.removes.push({key:p[g],u:d}),n.has=!0)}return n},applyDelta:function(e,t,n){var o=e.adds,s=e.removes;objectsDebug&&console.log("applyDelta"),objectsDebug&&console.log(e),objectsDebug&&console.log(t),objectsDebug&&console.log(n);for(var i=new ALMap,r=0;r<o.length;r++){var a=o[r];this.state.adds.contains(a.key)||this.state.adds.set(a.key,new ALMap);var c=this.state.adds.get(a.key);c.set(a.u,!0);var l=i.get(a.key);l||(l=new ALMap,i.set(a.key,l)),l.set(a.u,!0)}for(var u=0;u<s.length;u++){var h=s[u];this.state.removes.set(h.key,h.u)}for(var p=!1,t=Object.keys(this.getVersionVector()),r=0;r<t.length;r++){var g=this.getVersionVector()[t[r]];if(n[t[r]]&&n[t[r]]>g){p=!0;break}}for(var d=this.state.adds.keys(),f=0;f<d.length;f++){for(var c=this.state.adds.get(d[f]),v=c.keys(),y=0;y<v.length;y++){for(var u=0;u<s.length;u++)v[y]==s[u].u&&c["delete"](v[y]);if(p){var S=JSON.parse(v[y]);if(after(S,n));else if(i.contains(d[f])){var l=i.get(d[f]);l.contains(S)||c["delete"](v[y])}else c["delete"](v[y])}}0==c.size()&&this.state.adds["delete"](d[f])}}}};"undefined"!=typeof exports?exports.DELTA_Set=delta_set:CRDT_LIB.DELTA_Set=delta_set;var before=function(e,t){return t instanceof ALMap?!!t.contains(e.id)&&t.get(e.id)>e.o:!!t[e.id]&&t[e.id]>e.o},after=function(e,t){return t instanceof ALMap?!t.contains(e.id)||t.get(e.id)<e.o:!t[e.id]||t[e.id]<e.o};"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var op_counter={type:"OPERATIONS_Counter",propagation:CRDT.OP_BASED,crdt:{base_value:{state:{dec:ALMap,inc:ALMap}},getValue:function(){for(var e=0,t=this.state.dec.keys(),n=this.state.inc.keys(),o=0;o<t.length;o++)e-=this.state.dec.get(t[o]);for(var s=0;s<n.length;s++)e+=this.state.inc.get(n[s]);return e},operations:{increment:{local:function(e,t){return t||(t=e,e=this.objectStore.legion.id),{id:e,amount:t}},remote:function(e){return this.state.inc.contains(e.id)||this.state.inc.set(e.id,0),this.state.inc.set(e.id,this.state.inc.get(e.id)+e.amount),e.amount}},decrement:{local:function(e,t){return t||(t=e,e=this.objectStore.legion.id),{id:e,amount:t}},remote:function(e){return this.state.dec.contains(e.id)||this.state.dec.set(e.id,0),this.state.dec.set(e.id,this.state.dec.get(e.id)+e.amount),-e.amount}}}}};"undefined"!=typeof exports?exports.OPERATIONS_Counter=op_counter:CRDT_LIB.OPERATIONS_Counter=op_counter,"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2,8)}),"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var op_orMap={type:"OPERATIONS_Map",propagation:CRDT.OP_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){for(var e={},t=this.state.adds.keys(),n=0;n<t.length;n++)e[t[n]]=this.state.adds.get(t[n]).keys();return e},operations:{set:{local:function(e,t){var n=generateUniqueIdentifier(),o=this.state.adds.get(e);if(!o)return{key:e,value:t,unique:n,removes:[]};if(1==o.size()&&o.contains(t))return null;for(var s=o.values(),i=[],r=0;r<s.length;r++)i=i.concat(s[r].keys());return{key:e,value:t,unique:n,removes:i}},remote:function(e){if(e.key){var t={},n=e.key,o=e.value,s=e.unique,i=new ALMap;i.setAll(e.removes,!0),this.state.removes.setAll(e.removes,!0);var r=this.state.adds.get(n);if(this.state.removes.contains(s));else if(r||(r=new ALMap,this.state.adds.set(n,r)),0==r.size()){var a=new ALMap;a.set(s,!0),r.set(o,a),t.add={key:n,value:o}}else if(r.contains(o))if(r.get(o)==s)console.error("Duplicate unique.");else{var a=r.get(o);a.set(s,!0)}else{var a=r.get(o);a||(a=new ALMap,r.set(o,a)),a.set(s,!0),t.change={key:n,value:o}}if(t.removes=[],r){for(var c=r.keys(),l=0;l<c.length;l++){for(var u=r.get(c[l]).keys(),h=0;h<u.length;h++)i.contains(u[h])&&r.get(c[l])["delete"](u[h]);0==r.get(c[l]).size()&&(r["delete"](c[l]),t.removes.push({key:n,value:c[l]}))}0==r.size()&&this.state.adds["delete"](n)}return 0==t.removes.length&&delete t.removes,t.change||t.add||t.removes?t:void 0}}},contains:{local:function(e){return null},remote:function(e){return this.state.adds.contains(e)}},get:{local:function(e){return null},remote:function(e){return this.state.adds.get(e).keys()}},keys:{local:function(e){return null},remote:function(e){return this.state.adds.keys()}},asArray:{local:function(e){return null},remote:function(e){for(var t=[],n=this.state.adds.keys(),o=0;o<n.length;o++)t.push([n[o],this.state.adds.get(n[o]).keys()]);return t}},"delete":{local:function(e){var t=this.state.adds.get(e);if(t){for(var n=t.values(),o=[],s=0;s<n.length;s++)o=o.concat(n[s].keys());return{key:e,removes:o}}return null},remote:function(e){if(e.key){var t={},n=e.key,o=new ALMap;o.setAll(e.removes,!0),this.state.removes.setAll(e.removes,!0);var s=this.state.adds.get(n);t.removes=[];for(var i=s.keys(),r=0;r<i.length;r++){for(var a=s.get(i[r]).keys(),c=0;c<a.length;c++)o.contains(a[c])&&s.get(i[r])["delete"](a[c]);0==s.get(i[r]).size()&&(s["delete"](i[r]),t.removes.push({key:n,value:i[r]}))}return 0==s.size()&&this.state.adds["delete"](n),0==t.removes.length&&delete t.removes,t.removes?t:void 0}}}}}};"undefined"!=typeof exports?exports.OPERATIONS_Map=op_orMap:CRDT_LIB.OPERATIONS_Map=op_orMap,"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2,8)+(""+Math.random()).substr(2,8)}),"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var op_orset={type:"OPERATIONS_Set",propagation:CRDT.OP_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){return this.state.adds.keys()},operations:{asArray:{local:function(e){return null},remote:function(e){return this.state.adds.keys()}},add:{local:function(e){var t=generateUniqueIdentifier();return{element:e,unique:t}},remote:function(e){if(!this.state.removes.contains(e.unique)){this.state.adds.contains(e.element)||this.state.adds.set(e.element,new ALMap);var t=this.state.adds.get(e.element);if(!t.contains(e.unique))return t.set(e.unique,!0),{add:e.element}}}},remove:{local:function(e){var t=this.state.adds.get(e);if(!t)return{element:e,removes:[]};var n=t.keys();return{element:e,removes:n}},remote:function(e){if(0==e.removes.length)return{};for(var t=this.state.adds.get(e.element),n=0;n<e.removes.length;n++)this.state.removes.set(e.removes[n],!0),t&&t["delete"](e.removes[n]);return t&&0==t.size()?(this.state.adds["delete"](e.element),{remove:e.element}):void 0}}}}};"undefined"!=typeof exports?exports.OPERATIONS_Set=op_orset:CRDT_LIB.OPERATIONS_Set=op_orset,"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2,8)}),generateIds=function(e,t,n){var o,s=generateUniqueIdentifier(),i=e.get(t-1),r=e.get(t);return o=i&&r?newID(i.id,e.get(t).id,s):i?newID(i.id,null,s):r?newID(null,r.id,s):newID(null,null,s),1==n?o:void console.error("Not yet implemented.")},isAfter=function(e,t){for(var n=0;n<e.path.length&&n<t.path.length;n++)if(e.path[n]<t.path[n])return!0;return e.path.length>t.path.length?"0"==e.path[t.path.length]:e.path.length<t.path.length?"1"==t.path[e.path.length]:t.dis>e.dis},newID=function(e,t,n){var o={};return null==e&&null==t?o.path="":null==e?o.path=t.path+"0":null==t?o.path=e.path+"1":e.path.length>t.path.length?o.path=e.path+"1":o.path=t.path+"0",o.dis=n,o},"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap,DS_TableList=require("./../dataStructures/DS_TableList.js"),DS_TableList=DS_TableList.DS_TableList);var OP_Treedoc={type:"OPERATIONS_List",propagation:CRDT.OP_BASED,crdt:{base_value:{state:{list:DS_TableList,tombstones:ALMap}},getValue:function(){for(var e=[],t=0;t<this.state.list.size();t++)e.push(this.state.list.get(t).value);return e},operations:{asArray:{local:function(){return null},remote:function(e){for(var t=[],n=0;n<this.state.list.size();n++)t.push(this.state.list.get(n).value);return t}},addAll:{local:function(e,t){return{ids:generateIds(this.state.list,e,t.length),values:t}},remote:function(e){for(var t=0;t<this.state.list.size();t++)if(isAfter(this.state.list.get(t).id,e.ids[0].id)){for(var n=0;n<e.ids.length;n++)this.state.list.put(t,e.ids[e.ids.length-1-n]);return{added:e.values,pos:t,amount:e.ids.length}}}},set:{local:function(e,t){var n=this.state.list.get(e),o=generateIds(this.state.list,e,1);return{id:o,value:t,deleted:n.id.dis}},remote:function(e){for(var t=0;t<this.state.list.size();t++)if(this.state.list.get(t).id.dis==e.deleted){var n=this.state.list.get(t);return this.state.list.remove(t),this.state.list.put(t,{id:e.id,value:e.value}),{pos:t,removed:n.value,added:e.value}}}},get:{local:function(e){return null},remote:function(e){return this.state.list.get(e).value}},add:{local:function(e,t){console.info(e,t);var n=generateIds(this.state.list,e,1);return{id:n,value:t}},remote:function(e){if(0==this.state.list.size())return console.info(0),this.state.list.put(0,e),{pos:0,value:e.value};var t;for(t=0;t<this.state.list.size()&&isAfter(this.state.list.get(t).id,e.id);t++);return this.state.list.put(t,e),{pos:t,value:e.value}}},"delete":{local:function(e){var t=this.state.list.get(e);return t.id.dis},remote:function(e){for(var t=0;t<this.state.list.size();t++)if(this.state.list.get(t).id.dis==e){var n=this.state.list.get(t);return this.state.list.remove(t),{pos:t,removed:n.value}}}}}}};"undefined"!=typeof exports?exports.OPERATIONS_List=OP_Treedoc:CRDT_LIB.OPERATIONS_List=OP_Treedoc,"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var state_counter={type:"STATE_Counter",propagation:CRDT.STATE_BASED,crdt:{base_value:{state:{dec:ALMap,inc:ALMap}},getValue:function(){for(var e=0,t=this.state.dec.keys(),n=this.state.inc.keys(),o=0;o<t.length;o++)e-=this.state.dec.get(t[o]);for(var s=0;s<n.length;s++)e+=this.state.inc.get(n[s]);return e},operations:{increment:function(e,t){return t||(t=e,e=this.objectStore.legion.id),this.state.inc.contains(e)||this.state.inc.set(e,0),this.state.inc.set(e,this.state.inc.get(e)+t),t},decrement:function(e,t){return t||(t=e,e=this.objectStore.legion.id),this.state.dec.contains(e)||this.state.dec.set(e,0),this.state.dec.set(e,this.state.dec.get(e)+t),-t}},merge:function(e,t){for(var n=t.dec.keys(),o=t.inc.keys(),s=0,i=0;i<n.length;i++){var r=e.dec.get(n[i]);r?(s+=e.dec.get(n[i])-t.dec.get(n[i]),e.dec.set(n[i],Math.max(e.dec.get(n[i]),t.dec.get(n[i])))):(e.dec.set(n[i],t.dec.get(n[i])),s-=t.dec.get(n[i]))}for(var i=0;i<o.length;i++){var r=e.inc.get(o[i]);r?(s-=e.inc.get(o[i])-t.inc.get(o[i]),e.inc.set(o[i],Math.max(e.inc.get(o[i]),t.inc.get(o[i])))):(e.inc.set(o[i],t.inc.get(o[i])),s+=t.inc.get(o[i]))}var a={};return a.mergeResult=e,a.stateChange=s,a},compare:function(e,t){var n=!1,o=!1,s=e.inc,i=t.inc,r=e.dec,a=t.dec;if((s.size()>i.size()||r.size()>a.size())&&(n=!0),(i.size()>s.size()||a.size()>r.size())&&(o=!0),n&&o)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(!n){for(var c=s.keys(),l=0;l<c.length;l++){var u=c[l];if(!i.contains(u))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(s.get(u)>i.get(u)){n=!0;break}}for(var h=r.keys(),l=0;l<h.length;l++){var u=h[l];if(!a.contains(u))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(r.get(u)>a.get(u)){n=!0;break}}}if(!o){for(var p=i.keys(),l=0;l<p.length;l++){var u=p[l];if(!s.contains(u))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(i.get(u)>s.get(u)){o=!0;break}}for(var g=a.keys(),l=0;l<g.length;l++){var u=g[l];if(!r.contains(u))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(a.get(u)>r.get(u)){o=!0;break}}}return n&&!o?CRDT.STATE.COMPARE_RESPONSE.LOWER:!n&&o?CRDT.STATE.COMPARE_RESPONSE.HIGHER:n||o?CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE:CRDT.STATE.COMPARE_RESPONSE.EQUALS},fromJSONString:function(e){for(var t={dec:new ALMap,inc:new ALMap},n=e.dec,o=e.inc,s=0;s<n.length;s++)t.dec.set(n[s][0],n[s][1]);for(var s=0;s<o.length;s++)t.inc.set(o[s][0],o[s][1]);return t},toJSONString:function(e){for(var t=e.dec.keys(),n=e.inc.keys(),o=[],s=[],i=0;i<t.length;i++)o.push([t[i],e.dec.get(t[i])]);for(var i=0;i<n.length;i++)s.push([n[i],e.inc.get(n[i])]);return{dec:o,inc:s}}}};"undefined"!=typeof exports?exports.STATE_Counter=state_counter:CRDT_LIB.STATE_Counter=state_counter,"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2)}),"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var state_map={type:"STATE_Map",propagation:CRDT.STATE_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){for(var e={},t=this.state.adds.keys(),n=0;n<t.length;n++)e[t[n]]=this.state.adds.get(t[n]).keys();return e},operations:{asArray:function(){for(var e=[],t=this.state.adds.keys(),n=0;n<t.length;n++)e.push([t[n],this.state.adds.get(t[n]).keys()]);return e},set:function(e,t){var n,o=generateUniqueIdentifier(),s=[],i={},r=!1,a=this.state.removes;if(this.state.adds.contains(e)){n=this.state.adds.get(e);for(var c=n.keys(),l=0;l<c.length;l++)if(t!=c[l]){r=!0;for(var u=n.get(c[l]).keys(),h=0;h<u.length;h++)a.set(u[h],!0);n["delete"](c[l]),s.push(c[l])}}else this.state.adds.set(e,new ALMap),n=this.state.adds.get(e);return i.removes=s,n.contains(t)||n.set(t,new ALMap),n.get(t).contains(o)?console.error("Duplicate unique"):(n.get(t).set(o,!0),r?i.add={key:e,value:t}:i.change={key:e,value:t}),i.change=!0,i},"delete":function(e){var t={removes:[]};if(!this.state.adds.contains(e))return t;for(var n=this.state.adds.get(e),o=n.keys(),s=0;s<o.length;s++){for(var i=n.get(o[s]),r=i.keys(),a=0;a<r.length;a++)this.state.removes.set(r[a],!0);n["delete"](o[s]),t.removes.push({key:e,value:o[s]})}return this.state.adds["delete"](e),t.change=!0,t},contains:function(e){return this.state.adds.contains(e)},get:function(e){return this.state.adds.get(e).keys()},keys:function(){return this.state.adds.keys()},addRemoveUniques:function(e){for(var t=0;t<e.length;t++)this.state.removes.contains(e[t])||this.state.removes.set(e[t],!0);for(var n=this.state.adds,o=n.keys(),s=this.state.removes,t=0;t<o.length;t++){for(var i=n.get(o[t]),r=i.keys(),a=0;a<r.length;a++){for(var c=i.get(r[a]),l=c.keys(),u=0;u<l.length;u++)s.contains(l[u])&&c["delete"](l[u]);0==c.size()&&i["delete"](r[a])}0==i.size()&&n["delete"](o[t])}return{addRemoveUniques:e}},addRedisAddsAndRemovesUniques:function(e){for(var t=Object.keys(e),n=this.state.adds,o=this.state.removes,s=0;s<t.length;s++){if(!n.contains(t[s])){var i=new ALMap;n.set(t[s],i)}var r=n.get(t[s]),a=e[t[s]],c=Object.keys(a),l=a[c];if(!r.contains(c[0])){var i=new ALMap;r.set(c[0],i)}var u=r.get(c[0]);u.contains(l)||o.contains(l)||u.set(l,!0),0==u.size()&&(r["delete"](c[0]),0==r.size()&&n["delete"](t[s]))}}},compare:function(e,t){for(var n=!1,o=!1,s=e.removes.keys(),i=0;i<s.length;i++)if(!t.removes.contains(s[i])){n=!0;break}for(var r=t.removes.keys(),i=0;i<r.length;i++)if(!e.removes.contains(r[i])){o=!0;break}if(!n||!o){for(var a=e.adds.keys(),i=0;i<a.length;i++){var c=e.adds.get(a[i]),l=c.keys();if(t.adds.contains(a[i]))for(var u=t.adds.get(a[i]),h=0;h<l.length;h++){var p=c.get(l[h]).keys();if(u.contains(l[h])){for(var g=u.get(l[h]),d=0;d<p.length;d++)if(!g.contains(p[d])&&(t.removes.contains(p[d])?o=!0:n=!0,n&&o))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE}else for(var d=0;d<p.length;d++)if(t.removes.contains(p[d])?o=!0:n=!0,n&&o)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE}else for(var h=0;h<l.length;h++)for(var f=c.get(l[h]),p=f.keys(),d=0;d<p.length;d++)if(t.removes.contains(p[d])?o=!0:n=!0,n&&o)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE}for(var v=t.adds.keys(),i=0;i<v.length;i++){var u=t.adds.get(v[i]),y=u.keys();if(e.adds.contains(v[i]))for(var c=e.adds.get(v[i]),h=0;h<y.length;h++){var S=u.get(y[h]).keys();if(c.contains(y[h])){for(var m=c.get(y[h]),d=0;d<S.length;d++)if(!m.contains(S[d])&&(t.removes.contains(S[d])?n=!0:o=!0,n&&o))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE}else for(var d=0;d<S.length;d++)if(e.removes.contains(S[d])?n=!0:o=!0,n&&o)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE}else for(var h=0;h<y.length;h++)for(var f=u.get(y[h]),S=f.keys(),d=0;d<S.length;d++)if(e.removes.contains(S[d])?n=!0:o=!0,n&&o)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE}}return o||n?o?n?CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE:CRDT.STATE.COMPARE_RESPONSE.HIGHER:CRDT.STATE.COMPARE_RESPONSE.LOWER:CRDT.STATE.COMPARE_RESPONSE.EQUALS},merge:function(e,t){for(var n=t.removes.keys(),o=0;o<n.length;o++)e.removes.contains(n[o])||e.removes.set(n[o],!0);for(var s=e.adds.keys(),o=0;o<s.length;o++){for(var i=e.adds.get(s[o]),r=i.keys(),a=0;a<r.length;a++){for(var c=i.get(r[a]),l=c.keys(),u=0;u<l.length;u++)e.removes.contains(l[u])&&c["delete"](l[u]);0==c.size()&&i["delete"](r[a])}0==i.size()&&e.adds["delete"](s[o])}for(var h=t.adds.keys(),o=0;o<h.length;o++){var p=t.adds.get(h[o]),g=p.keys();e.adds.contains(h[o])||e.adds.set(h[o],new ALMap);for(var d=e.adds.get(h[o]),a=0;a<g.length;a++){d.contains(g[a])||d.set(g[a],new ALMap);for(var f=d.get(g[a]),v=p.get(g[a]).keys(),u=0;u<v.length;u++)f.contains(v[u])||e.removes.contains(v[u])||f.set(v[u],!0);0==f.size()&&d["delete"](g[a])}0==d.size()&&e.adds["delete"](h[o])}var y={};return y.mergeResult=e,y},fromJSONString:function(e){for(var t=new ALMap,n=new ALMap,o=e.adds,s=e.removes,i=0;i<s.length;i++)n.set(s[i],!0);for(var i=0;i<o.length;i++){for(var r=new ALMap,a=o[i][0][0],c=o[i][0][1],l=0;l<c;l++){for(var u=o[i][l+1][0],h=new ALMap,p=o[i][l+1][1],g=0;g<p;g++)h.set(o[i][l+1][2+g],!0);r.set(u,h)}t.set(a,r)}return{adds:t,removes:n}},toJSONString:function(e){var t=e.adds,n=e.removes,o=[],s=[];s=n.keys();for(var i=t.keys(),r=0;r<i.length;r++){var a=t.get(i[r]),c=a.keys(),l=[],u=[];u[0]=i[r],u[1]=c.length,l.push(u);for(var h=0;h<c.length;h++){var p=[];p[0]=c[h];var g=a.get(c[h]),d=g.keys();p[1]=d.length;for(var f=0;f<d.length;f++)p[2+f]=d[f];l.push(p)}o.push(l)}return{adds:o,removes:s}}}};"undefined"!=typeof exports?exports.STATE_Map=state_map:CRDT_LIB.STATE_Map=state_map,"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2,8)+(""+Math.random()).substr(2,8)}),"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var state_set={type:"STATE_Set",propagation:CRDT.STATE_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){return this.state.adds.keys()},operations:{asArray:function(){return this.state.adds.keys()},add:function(e){if(!this.state.adds.contains(e)){this.state.adds.set(e,new ALMap);var t=this.state.adds.get(e);return t.set(generateUniqueIdentifier(),!0),{add:e,change:!0}}},remove:function(e){var t=this.state.adds.get(e);if(t){for(var n={element:e,removes:t.keys()},o=0;o<n.removes.length;o++)this.state.removes.set(n.removes[o],!0),t["delete"](n.removes[o]);if(0==t.size())return this.state.adds["delete"](n.element),{remove:n.element,change:!0}}}},merge:function(e,t){e.removes.setAll(t.removes.keys(),!0);for(var n={adds:[],removes:[]},o=t.adds.keys(),s=0;s<o.length;s++)for(var i=t.adds.get(o[s]),r=i.keys(),a=0;a<r.length;a++)if(e.removes.contains(r[a]));else{var c=e.adds.get(o[s]);c||(c=new ALMap,e.adds.set(o[s],c),n.adds.push(o[s])),c.contains(r[a])||c.set(r[a],!0)}for(var l=e.adds.keys(),u=0;u<l.length;u++){for(var h=e.adds.get(l[u]),p=h.keys(),g=0;g<p.length;g++)e.removes.contains(p[g])&&h["delete"](p[g]);0==h.size()&&(n.removes.push(l[u]),e.adds["delete"](l[u]))}var d={};return d.mergeResult=e,d.stateChange=n,d},compare:function(e,t){var n=!1,o=!1,s=e.removes.keys(),i=t.removes.keys();if(s.length>i.length?n=!0:i.length>s.length&&(o=!0),!n)for(var r=0;r<s.length;r++)if(!t.removes.contains(s[r])){n=!0;break}if(n&&o)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(!o)for(var r=0;r<i.length;r++)if(!e.removes.contains(i[r])){o=!0;break}if(n&&o)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;for(var a=e.adds.keys().concat(t.adds.keys()),r=0;r<a.length&&(!o||!n);r++){var c=e.adds.get(a[r]),l=t.adds.get(a[r]);if(c)if(l){for(var u=c.keys(),h=l.keys(),p=0;!n&&p<u.length;p++)l.contains(u[p])||(n=!0);for(var p=0;!o&&p<h.length;p++)c.contains(h[p])||(o=!0)}else n=!0;else o=!0}return n&&!o?CRDT.STATE.COMPARE_RESPONSE.LOWER:!n&&o?CRDT.STATE.COMPARE_RESPONSE.HIGHER:n||o?CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE:CRDT.STATE.COMPARE_RESPONSE.EQUALS},fromJSONString:function(e){for(var t={adds:new ALMap,removes:new ALMap},n=e.adds,o=e.removes,s=0;s<n.length;s++){var i=n[s].key,r=n[s].us,a=new ALMap;a.setAll(r,!0),t.adds.set(i,a)}return t.removes.setAll(o,!0),t},toJSONString:function(e){for(var t={adds:[],removes:e.removes.keys()},n=e.adds.keys(),o=0;o<n.length;o++)t.adds.push({key:n[o],us:e.adds.get(n[o]).keys()});return t}}};"undefined"!=typeof exports?exports.STATE_Set=state_set:CRDT_LIB.STATE_Set=state_set;
