function ALMap(){this.map=[]}function Duplicates(){this.senders=[]}function RangeSet(){this.pairs=[]}function ConnectionManager(e){this.legion=e,this.serverConnection=null,this.peerConnections=new ALMap;var n=this;this.legion.messagingAPI.setHandlerFor("OfferAsAnswer",function(e){n.handleSignalling(e)}),this.legion.messagingAPI.setHandlerFor("OfferReturn",function(e){n.handleSignalling(e)}),this.legion.messagingAPI.setHandlerFor("ICE",function(e){n.handleSignalling(e)})}function Legion(e){this.options=e,this.messageCount=0,this.id=this.options.clientID,this.messagingAPI=new MessagingAPI(this,this.legion),this.overlay=new Overlay(this,this.legion),this.connectionManager=new ConnectionManager(this)}function MessagingAPI(e){this.legion=e,this.messagingProtocol=new this.legion.options.messagingProtocol(this,this.legion),this.callbacks=new ALMap,this.duplicates=new Duplicates}function Overlay(e){this.legion=e,this.peers=new ALMap,this.overlayProtocol=new this.legion.options.overlayProtocol(this,this.legion)}function PeerConnection(e,n){detailedDebug&&console.log("PC from "+n.id+" to "+e),this.remoteID=e,this.legion=n,this.peer=new RTCPeerConnection(servers,pcConstraint),this.channel=null}function ServerConnection(e){this.legion=e,this.server=this.legion.options.server,this.remoteID=this.server.ip+":"+this.server.port,this.socket=new WebSocket("ws://"+this.server.ip+":"+this.server.port);var n=this;this.socket.onopen=function(){n.legion.connectionManager.onOpenServer(n)},this.socket.onmessage=function(e){var t=JSON.parse(e.data),o=JSON.parse(e.data);t.content?decompress(t.content,function(e){t.content=JSON.parse(e),n.legion.messagingAPI.onMessage(n,t,o)}):n.legion.messagingAPI.onMessage(n,t,o)},this.socket.onclose=function(){n.legion.connectionManager.onCloseServer(n)},this.socket.onerror=function(e){console.error("ServerSocket Error",e)}}function FloodMessaging(e,n){this.messagingAPI=e,this.legion=n}function SimpleOverlay(e,n){this.overlay=e,this.legion=n;var t=this;this.interval=setInterval(function(){t.floodJoin()},15e3),this.legion.messagingAPI.setHandlerFor("ConnectToAnyNodesPlease",function(e){t.handleJoin(e)})}var fromDecToHex=function(e){if(0>e)return e=4294967295+e+1,e.toString(16).substring(6,8);var n=e.toString(16);return 1==n.length&&(n="0"+n),n},fromHexToDec=function(e){return parseInt(e,16)},compress=function(e,n){"undefined"!=typeof LZMA?LZMA.compress(e,1,function(e){for(var t="",o=0;o<e.length;o++)t+=fromDecToHex(e[o]);n(t)},function(){}):n(e)},decompress=function(e,n){for(var t=[],o=0;o<e.length;o+=2)t.push(fromHexToDec(e[o]+e[o+1]));"undefined"!=typeof LZMA?LZMA.decompress(t,function(e){n(e)},function(){}):n(e)};"undefined"!=typeof exports&&(exports.ALMap=ALMap),ALMap.prototype.set=function(e,n){this.map[e]=n},ALMap.prototype["delete"]=function(e){delete this.map[e]},ALMap.prototype.get=function(e){return this.map[e]},ALMap.prototype.contains=function(e){return"undefined"!=typeof this.map[e]},ALMap.prototype.keys=function(){return Object.keys(this.map)},ALMap.prototype.size=function(){return Object.keys(this.map).length};var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(e,n){console.log("Attaching media stream"),e.mozSrcObject=n,e.play()},reattachMediaStream=function(e,n){console.log("Reattaching media stream"),e.mozSrcObject=n.mozSrcObject,e.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(debug&&console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(e,n){"undefined"!=typeof e.srcObject?e.srcObject=n:"undefined"!=typeof e.mozSrcObject?e.mozSrcObject=n:"undefined"!=typeof e.src?e.src=URL.createObjectURL(n):console.log("Error attaching stream to element.")},reattachMediaStream=function(e,n){e.src=n.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):(RTCPeerConnection=null,console.log("Browser does not appear to be WebRTC-capable")),"undefined"!=typeof exports&&(exports.Duplicates=Duplicates),Duplicates.prototype.add=function(e,n){this.senders[e]||(this.senders[e]=new RangeSet),this.senders[e].add(n)},Duplicates.prototype.contains=function(e,n){return this.senders[e]?this.senders[e].contains(n):!1},Duplicates.prototype.print=function(){for(var e=Object.keys(this.senders),n=0;n<e.length;n++)console.log(e[n]),this.senders[e[n]].print()},RangeSet.prototype.add=function(e){for(var n=this.pairs.length-1;n>=0;n--){if(e>=this.pairs[n].first&&e<=this.pairs[n].last)return;if(e==this.pairs[n].last+1){for(this.pairs[n].last+=1;this.pairs[n-1]&&this.pairs[n].last==this.pairs[n-1].first-1;)this.pairs[n].last=this.pairs[n-1].last,this.pairs.splice(n-1,1),n--;return}if(e==this.pairs[n].first-1)return void(this.pairs[n].first-=1);if(e<this.pairs[n].first)return void this.pairs.splice(n+1,0,{first:e,last:e})}this.pairs.splice(0,0,{first:e,last:e})},RangeSet.prototype.contains=function(e){for(var n=0;n<this.pairs.length;n++)if(e>=this.pairs[n].first&&e<=this.pairs[n].last)return!0;return!1},RangeSet.prototype.print=function(){for(var e=0;e<this.pairs.length;e++)console.log(this.pairs[e].first+" : "+this.pairs[e].last)},ConnectionManager.prototype.startSignallingConnection=function(){new ServerConnection(this.legion)},ConnectionManager.prototype.hasPeer=function(e){return this.peerConnections.contains(e)},ConnectionManager.prototype.connectPeer=function(e){this.peerConnections.set(e,new PeerConnection(e,this.legion)),this.peerConnections.get(e).startLocal()},ConnectionManager.prototype.connectPeerRemote=function(e){var n=e.sender,t=e.content;this.peerConnections.set(n,new PeerConnection(n,this.legion)),this.peerConnections.get(n).startRemote(t)},ConnectionManager.prototype.handleSignalling=function(e){if(e.destination!=this.legion.id)this.legion.messagingAPI.broadcastMessage(e);else switch(e.type){case"OfferAsAnswer":return void this.connectPeerRemote(e);case"OfferReturn":return void this.peerConnections.get(e.sender).returnOffer(e.content);case"ICE":return void this.peerConnections.get(e.sender).return_ice(e.content)}},ConnectionManager.prototype.onCloseServer=function(e){console.log(this.legion.getTime()+" Overlay CLOSE "+this.legion.id+" to "+e.remoteID),this.serverConnection=null,this.legion.overlay.onServerDisconnect(e)},ConnectionManager.prototype.onOpenServer=function(e){console.log(this.legion.getTime()+" Overlay OPEN "+this.legion.id+" to "+e.remoteID),this.serverConnection=e,this.legion.overlay.onServerConnection(e)},ConnectionManager.prototype.onOpenClient=function(e){console.log(this.legion.getTime()+" Overlay OPEN "+this.legion.id+" to "+e.remoteID),this.legion.overlay.addPeer(e)},ConnectionManager.prototype.onCloseClient=function(e){console.log(this.legion.getTime()+" Overlay CLOSE "+this.legion.id+" to "+e.remoteID),this.peerConnections["delete"](e.remoteID),this.legion.overlay.removePeer(e)},ConnectionManager.prototype.sendStartOffer=function(e,n){var t=this;this.legion.generateMessage("OfferAsAnswer",e,function(e){e.destination=n.remoteID,t.legion.messagingAPI.broadcastMessage(e)})},ConnectionManager.prototype.sendReturnOffer=function(e,n){var t=this;this.legion.generateMessage("OfferReturn",e,function(e){e.destination=n.remoteID,t.legion.messagingAPI.broadcastMessage(e)})},ConnectionManager.prototype.sendICE=function(e,n){var t=this;this.legion.generateMessage("ICE",e,function(e){e.destination=n.remoteID,t.legion.messagingAPI.broadcastMessage(e)})},Legion.prototype.join=function(){this.connectionManager.startSignallingConnection()},Legion.prototype.getMessageAPI=function(){return this.messagingAPI},Legion.prototype.generateMessage=function(e,n,t){var o={type:e,sender:this.id,ID:++this.messageCount};n?compress(JSON.stringify(n),function(e){o.content=e,t(o)},function(e){console.error("Compress failed!",e),t(null)}):t(o)},Legion.prototype.getTime=function(){return Date.now()},MessagingAPI.prototype.onMessage=function(e,n,t){return n.sender==this.legion.id?void(debug&&console.info("return to creator fault from: "+e.remoteID)):void(this.duplicates.contains(n.sender,n.ID)||(this.duplicates.add(n.sender,n.ID),(!n.destination||n.destination&&n.destination==this.legion.id)&&this.deliver(n),debug&&console.log(n.type+" from "+e.remoteID+" by "+n.sender+" to "+n.destination),detailedDebug&&console.log(n),this.messagingProtocol.onMessage(e,n,t)))},MessagingAPI.prototype.deliver=function(e){this.callbacks.contains(e.type)&&this.callbacks.get(e.type)(e)},MessagingAPI.prototype.broadcastMessage=function(e){this.messagingProtocol.broadcastMessage(e)},MessagingAPI.prototype.broadcast=function(e,n){var t=this;this.legion.generateMessage(e,n,function(e){t.broadcastMessage(e)})},MessagingAPI.prototype.setHandlerFor=function(e,n){this.callbacks.set(e,n)},Overlay.prototype.peerCount=function(){return this.peers.size()},Overlay.prototype.addPeer=function(e){this.peers.set(e.remoteID,e),this.overlayProtocol.onClientConnection(e)},Overlay.prototype.removePeer=function(e){this.peers["delete"](e.remoteID),this.overlayProtocol.onClientDisconnect(e)},Overlay.prototype.onServerDisconnect=function(e){this.overlayProtocol.onServerDisconnect(e)},Overlay.prototype.onServerConnection=function(e){this.overlayProtocol.onServerConnection(e)},Overlay.prototype.getPeers=function(e){var n=this.peers.keys();return n.slice(0,e)},PeerConnection.prototype.setChannelHandlers=function(){var e=this;this.channel.onmessage=function(n){var t=JSON.parse(n.data),o=JSON.parse(n.data);t.content?decompress(t.content,function(n){t.content=JSON.parse(n),e.legion.messagingAPI.onMessage(e,t,o)}):e.legion.messagingAPI.onMessage(e,t,o)},this.channel.onopen=function(n){e.legion.connectionManager.onOpenClient(e)},this.channel.onclose=function(n){e.legion.connectionManager.onCloseClient(e)}},PeerConnection.prototype.returnOffer=function(e){detailedDebug&&console.log(e),this.peer.setRemoteDescription(new RTCSessionDescription(e))},PeerConnection.prototype.return_ice=function(e){detailedDebug&&console.log(e),this.peer.addIceCandidate(new RTCIceCandidate(e),function(){},function(e){console.error("onAddIceCandidateError",e)})},PeerConnection.prototype.onicecandidate=function(e){e.candidate&&this.legion.connectionManager.sendICE(e.candidate,this)},PeerConnection.prototype.startLocal=function(){debug&&console.log("start local: "+this.remoteID);var e=this;this.channel=this.peer.createDataChannel("sendDataChannel",dataConstraint),this.setChannelHandlers(),this.peer.onicecandidate=function(n){e.onicecandidate(n)},this.peer.createOffer(function(n){e.peer.setLocalDescription(n),e.legion.connectionManager.sendStartOffer(n,e)},function(n){console.error("onCreateSessionDescriptionError",n),e.onclose()})},PeerConnection.prototype.startRemote=function(e){detailedDebug&&console.log(e),debug&&console.log("start remote: "+this.remoteID),this.peer.setRemoteDescription(new RTCSessionDescription(e));var n=this;this.peer.ondatachannel=function(e){n.channel=e.channel,n.setChannelHandlers()},this.peer.onicecandidate=function(e){n.onicecandidate(e)},this.peer.createAnswer(function(e){n.peer.setLocalDescription(e),n.legion.connectionManager.sendReturnOffer(e,n)},function(e){console.error("onCreateSessionDescriptionError",e),n.onclose()})},PeerConnection.prototype.send=function(e){"object"==typeof e&&(e=JSON.stringify(e)),this.channel&&"open"==this.channel.readyState&&this.channel.send(e)};var servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]},pcConstraint={optional:[{RtpDataChannels:!1}]},dataConstraint=null;ServerConnection.prototype.send=function(e){"object"==typeof e&&(e=JSON.stringify(e)),this.socket.readyState==WebSocket.OPEN&&this.socket.send(e)},FloodMessaging.prototype.onMessage=function(e,n,t){(!n.destination||n.destination&&n.destination!=this.legion.id)&&this.messagingAPI.messagingProtocol.broadcastMessage(t)},FloodMessaging.prototype.broadcastMessage=function(e){for(var n=this.legion.overlay.getPeers(this.legion.overlay.peerCount()),t=0;t<n.length;t++)n[t].send(e);var o=this.legion.connectionManager.serverConnection;o&&o.send(e)},SimpleOverlay.prototype.onClientConnection=function(e){},SimpleOverlay.prototype.onClientDisconnect=function(e){},SimpleOverlay.prototype.onServerConnection=function(e){this.init(e)},SimpleOverlay.prototype.onServerDisconnect=function(e){},SimpleOverlay.prototype.init=function(e){this.legion.generateMessage("ConnectToAnyNodesPlease",null,function(n){e.send(n)})},SimpleOverlay.prototype.floodJoin=function(){var e=this.overlay.peers,n=this.legion.connectionManager.serverConnection;n||this.legion.connectionManager.startSignallingConnection(),this.legion.generateMessage("ConnectToAnyNodesPlease",null,function(t){n&&n.send(t);for(var o=0;o<e.length;o++)e[o].send(t)})},SimpleOverlay.prototype.handleJoin=function(e){this.legion.connectionManager.hasPeer(e.sender)||this.legion.connectionManager.connectPeer(e.sender)};
